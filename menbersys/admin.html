<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TKYæ ªå¼ä¼šç¤¾ - ç®¡ç†è€…ãƒ‘ãƒãƒ«</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <div class="responsive-wrapper">
            <header class="app-header">
                <div class="header-content">
                    <div class="logo-section">
                        <div class="logo-badge">
                            <span class="logo-initial">TKY</span>
                        </div>
                        <div class="logo-text">
                            <h1 class="company-name">TKYæ ªå¼ä¼šç¤¾</h1>
                            <p class="system-title">ç®¡ç†è€…ãƒ‘ãƒãƒ«</p>
                        </div>
                    </div>
                    <div class="header-actions">
                        <button id="backToMain" class="back-btn">
                            <span class="icon">â†</span>
                            ãƒ¡ã‚¤ãƒ³ç”»é¢ã¸æˆ»ã‚‹
                        </button>
                    </div>
                </div>
            </header>
            
            <!-- Supabase è¿æ¥çŠ¶æ€æç¤º -->
            <div id="supabaseStatus" style="margin: 10px 20px; padding: 10px; border-radius: 5px; display: none;"></div>
            
            <main class="main-content">
                <div class="form-card">
                    <div class="card-header">
                        <h2 class="form-title">ãƒ¡ãƒ³ãƒãƒ¼ç®¡ç†</h2>
                        <p class="form-subtitle">ãƒ¡ãƒ³ãƒãƒ¼ã®è¿½åŠ ãƒ»ç·¨é›†ãƒ»å‰Šé™¤ãŒã§ãã¾ã™</p>
                    </div>
                    
                    <form id="memberForm" class="member-form">
                        <div class="form-group">
                            <label for="memberName" class="form-label">æ°å</label>
                            <input type="text" id="memberName" class="form-input" required placeholder="æ°åã‚’å…¥åŠ›">
                        </div>
                        
                        <div class="form-group">
                            <label for="username" class="form-label">ãƒ¦ãƒ¼ã‚¶ãƒ¼å</label>
                            <input type="text" id="username" class="form-input" required placeholder="ãƒ¦ãƒ¼ã‚¶ãƒ¼åã‚’å…¥åŠ›">
                        </div>
                        
                        <div class="form-group">
                            <label for="password" class="form-label">ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰</label>
                            <input type="password" id="password" class="form-input" required placeholder="ãƒ‘ã‚¹ãƒ¯ãƒ¼ãƒ‰ã‚’å…¥åŠ›">
                        </div>
                        
                        <div class="form-group">
                            <label for="team" class="form-label">ãƒãƒ¼ãƒ </label>
                            <select id="team" class="form-select" required>
                                <option value="">é¸æŠã—ã¦ãã ã•ã„</option>
                            </select>
                        </div>
                        
                        <div class="form-actions">
                            <button type="submit" class="submit-btn">
                                <span class="icon">â•</span>
                                ãƒ¡ãƒ³ãƒãƒ¼è¿½åŠ 
                            </button>
                            <button type="button" id="clearForm" class="clear-btn">
                                <span class="icon">ğŸ—‘ï¸</span>
                                ã‚¯ãƒªã‚¢
                            </button>
                        </div>
                    </form>
                </div>
                
                <div class="members-list">
                    <h3 class="list-title">ç™»éŒ²æ¸ˆã¿ãƒ¡ãƒ³ãƒãƒ¼</h3>
                    <div id="membersContainer" class="members-container">
                        <!-- ãƒ¡ãƒ³ãƒãƒ¼ãƒªã‚¹ãƒˆãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <!-- åŠ è½½ Supabase CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Supabase é…ç½®
        const supabaseUrl = 'https://xhqvbirifrdlmlnrwayp.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhocXZiaXJpZnJkbG1sbnJ3YXlwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA1MTYzNzQsImV4cCI6MjA3NjA5MjM3NH0.CFLPI0sTrO5CYezI2BZRPyaLFS_A7NdxBbZ08qpTlVc';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        // æ•°æ®å­˜å‚¨é”®
        const STORAGE_KEY = 'tky_attendance_system';
        const MEMBERS_KEY = 'members';
        const TEAMS_KEY = 'teams';
        const SITES_KEY = 'sites';

        // åˆæœŸãƒ‡ãƒ¼ã‚¿
        const initialData = {
            [MEMBERS_KEY]: [
                { id: 1, name: 'å±±ç”°å¤ªéƒ', team: 'ãƒãƒ¼ãƒ A' },
                { id: 2, name: 'ä½è—¤èŠ±å­', team: 'ãƒãƒ¼ãƒ B' }
            ],
            [TEAMS_KEY]: ['ãƒãƒ¼ãƒ A', 'ãƒãƒ¼ãƒ B', 'ãƒãƒ¼ãƒ C'],
            [SITES_KEY]: ['æ±äº¬ã‚µã‚¤ãƒˆ', 'å¤§é˜ªã‚µã‚¤ãƒˆ', 'åå¤å±‹ã‚µã‚¤ãƒˆ', 'æ¸‹è°·ã‚µã‚¤ãƒˆ']
        };

        // ãƒ‡ãƒ¼ã‚¿å–å¾—é–¢æ•°
        function getData(key) {
            const data = JSON.parse(localStorage.getItem(STORAGE_KEY)) || initialData;
            return key ? data[key] : data;
        }

        // ãƒ‡ãƒ¼ã‚¿ä¿å­˜é–¢æ•°
        function saveData(key, value) {
            const data = getData();
            data[key] = value;
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        }

        // æ•°æ®æ˜ å°„è¾…åŠ©å‡½æ•°
        let teamMap = null;

        // è·å–å›¢é˜ŸID
        async function getTeamId(teamName) {
            if (!teamMap) {
                const { data, error } = await supabase.from('teams').select('id, name');
                if (!error) {
                    teamMap = Object.fromEntries(data.map(t => [t.name, t.id]));
                } else {
                    console.error('è·å–å›¢é˜Ÿæ•°æ®å¤±è´¥:', error);
                    return null;
                }
            }
            return teamMap?.[teamName] || null;
        }

        // é¡µé¢åŠ è½½æ—¶æµ‹è¯• Supabase è¿æ¥
        document.addEventListener('DOMContentLoaded', async function() {
            const statusDiv = document.getElementById('supabaseStatus');
            
            try {
                // æµ‹è¯•è¿æ¥ - å°è¯•è·å–ä¸€ä¸ªç®€å•çš„æŸ¥è¯¢
                const { data, error } = await supabase
                    .from('teams')
                    .select('id')
                    .limit(1);
                
                if (error) {
                    throw error;
                }
                
                // æ˜¾ç¤ºæˆåŠŸè¿æ¥æ¶ˆæ¯
                statusDiv.style.display = 'block';
                statusDiv.style.backgroundColor = '#d4edda';
                statusDiv.style.color = '#155724';
                statusDiv.style.border = '1px solid #c3e6cb';
                statusDiv.innerHTML = 'âœ… æˆåŠŸè¿æ¥äº‘ç«¯æ•°æ®åº“ (Supabase)';
                
            } catch (error) {
                // è¿æ¥å¤±è´¥æ—¶æ˜¾ç¤ºé”™è¯¯æ¶ˆæ¯
                console.log('Supabase è¿æ¥æµ‹è¯•å¤±è´¥:', error.message);
                statusDiv.style.display = 'block';
                statusDiv.style.backgroundColor = '#f8d7da';
                statusDiv.style.color = '#721c24';
                statusDiv.style.border = '1px solid #f5c6cb';
                statusDiv.innerHTML = `âŒ æ•°æ®åº“è¿æ¥å¤±è´¥: ${error.message}`;
            }
            
            // åˆå§‹åŒ–é¡µé¢åŠŸèƒ½
            initializePage();
        });

        // åˆå§‹åŒ–é¡µé¢åŠŸèƒ½
        function initializePage() {
            // å›¢é˜Ÿé€‰æ‹©é¡¹æ›´æ–°
            const teamSelect = document.getElementById('team');
            teamSelect.innerHTML = '<option value="">é¸æŠã—ã¦ãã ã•ã„</option>';
            getData(TEAMS_KEY).forEach(team => {
                const option = document.createElement('option');
                option.value = team;
                option.textContent = team;
                teamSelect.appendChild(option);
            });

            // è¿”å›ä¸»é¡µé¢æŒ‰é’®
            document.getElementById('backToMain').addEventListener('click', function() {
                window.location.href = 'index.html';
            });

            // æˆå‘˜è¡¨å•æäº¤
            document.getElementById('memberForm').addEventListener('submit', async function(e) {
                e.preventDefault();

                const name = document.getElementById('memberName').value;
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;
                const team = document.getElementById('team').value;

                // ä¿¡æ¯ç¡®è®¤
                const confirmMsg = 
                    `ä»¥ä¸‹ã®å†…å®¹ã§ãƒ¡ãƒ³ãƒãƒ¼ã‚’è¿½åŠ ã—ã¾ã™ã€‚\n\n` +
                    `æ°å: ${name}\n` +
                    `ãƒ¦ãƒ¼ã‚¶ãƒ¼å: ${username}\n` +
                    `ãƒãƒ¼ãƒ : ${team}\n\n` +
                    `ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ`;
                if (!window.confirm(confirmMsg)) {
                    return;
                }

                // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                const members = getData(MEMBERS_KEY);
                const newMember = {
                    id: Date.now(),
                    name: name,
                    username: username,
                    password: password,
                    team: team
                };
                members.push(newMember);
                saveData(MEMBERS_KEY, members);

                // åŒæ­¥åˆ°Supabase
                try {
                    const teamId = await getTeamId(team);
                    if (teamId) {
                        const { data, error } = await supabase
                            .from('members')
                            .upsert({
                                name: name,
                                username: username,
                                password: password,
                                team_id: teamId
                            }, { onConflict: 'username' });
                            
                        if (error) {
                            console.error('Supabase åŒæ­¥å¤±è´¥:', error);
                            alert('æˆå‘˜å·²ä¿å­˜åˆ°æœ¬åœ°ï¼Œä½†äº‘ç«¯åŒæ­¥å¤±è´¥');
                        } else {
                            console.log('æˆå‘˜æ•°æ®å·²åŒæ­¥åˆ° Supabase');
                        }
                    } else {
                        console.warn('æ— æ³•æ‰¾åˆ°å¯¹åº”çš„å›¢é˜ŸIDï¼Œè·³è¿‡SupabaseåŒæ­¥');
                        alert('æˆå‘˜å·²ä¿å­˜åˆ°æœ¬åœ°ï¼Œä½†äº‘ç«¯åŒæ­¥éœ€è¦å›¢é˜Ÿæ˜ å°„');
                    }
                } catch (error) {
                    console.error('Supabase åŒæ­¥è¿‡ç¨‹ä¸­å‡ºé”™:', error);
                    alert('æˆå‘˜å·²ä¿å­˜åˆ°æœ¬åœ°ï¼Œä½†äº‘ç«¯åŒæ­¥å‡ºé”™');
                }

                // æ›´æ–°æˆå‘˜åˆ—è¡¨
                updateMembersList();
                
                // è¡¨å•é‡ç½®
                this.reset();
                alert('ãƒ¡ãƒ³ãƒãƒ¼ãŒè¿½åŠ ã•ã‚Œã¾ã—ãŸï¼');
            });

            // æ¸…é™¤è¡¨å•æŒ‰é’®
            document.getElementById('clearForm').addEventListener('click', function() {
                document.getElementById('memberForm').reset();
            });

            // åˆå§‹åŒ–æˆå‘˜åˆ—è¡¨
            updateMembersList();
        }

        // æ›´æ–°æˆå‘˜åˆ—è¡¨
        function updateMembersList() {
            const members = getData(MEMBERS_KEY);
            const container = document.getElementById('membersContainer');
            
            container.innerHTML = '';
            
            if (members.length === 0) {
                container.innerHTML = '<p class="no-members">ç™»éŒ²ã•ã‚Œã¦ã„ã‚‹ãƒ¡ãƒ³ãƒãƒ¼ã¯ã„ã¾ã›ã‚“</p>';
                return;
            }
            
            members.forEach(member => {
                const memberElement = document.createElement('div');
                memberElement.className = 'member-item';
                memberElement.innerHTML = `
                    <div class="member-info">
                        <strong>${member.name}</strong> (${member.username})
                        <span class="member-team">${member.team}</span>
                    </div>
                    <div class="member-actions">
                        <button class="edit-btn" data-id="${member.id}">ç·¨é›†</button>
                        <button class="delete-btn" data-id="${member.id}">å‰Šé™¤</button>
                    </div>
                `;
                container.appendChild(memberElement);
            });

            // æ·»åŠ åˆ é™¤äº‹ä»¶ç›‘å¬å™¨
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const memberId = parseInt(this.getAttribute('data-id'));
                    deleteMember(memberId);
                });
            });

            // æ·»åŠ ç¼–è¾‘äº‹ä»¶ç›‘å¬å™¨
            document.querySelectorAll('.edit-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const memberId = parseInt(this.getAttribute('data-id'));
                    editMember(memberId);
                });
            });
        }

        // åˆ é™¤æˆå‘˜
        function deleteMember(memberId) {
            if (!confirm('ã“ã®ãƒ¡ãƒ³ãƒãƒ¼ã‚’å‰Šé™¤ã—ã¦ã‚‚ã‚ˆã‚ã—ã„ã§ã™ã‹ï¼Ÿ')) {
                return;
            }
            
            const members = getData(MEMBERS_KEY);
            const updatedMembers = members.filter(member => member.id !== memberId);
            saveData(MEMBERS_KEY, updatedMembers);
            updateMembersList();
            alert('ãƒ¡ãƒ³ãƒãƒ¼ã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
        }

        // ç¼–è¾‘æˆå‘˜
        function editMember(memberId) {
            const members = getData(MEMBERS_KEY);
            const member = members.find(m => m.id === memberId);
            
            if (!member) return;
            
            // å¡«å……è¡¨å•
            document.getElementById('memberName').value = member.name;
            document.getElementById('username').value = member.username;
            document.getElementById('password').value = member.password;
            document.getElementById('team').value = member.team;
            
            // ä¿®æ”¹æäº¤æŒ‰é’®æ–‡æœ¬
            const submitBtn = document.querySelector('#memberForm .submit-btn');
            submitBtn.innerHTML = '<span class="icon">âœï¸</span>ãƒ¡ãƒ³ãƒãƒ¼æ›´æ–°';
            
            // ä¸´æ—¶ä¿®æ”¹æäº¤äº‹ä»¶
            const form = document.getElementById('memberForm');
            const originalSubmit = form.onsubmit;
            
            form.onsubmit = async function(e) {
                e.preventDefault();
                
                const name = document.getElementById('memberName').value;
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;
                const team = document.getElementById('team').value;
                
                // æ›´æ–°æœ¬åœ°å­˜å‚¨
                const members = getData(MEMBERS_KEY);
                const memberIndex = members.findIndex(m => m.id === memberId);
                if (memberIndex !== -1) {
                    members[memberIndex] = { ...members[memberIndex], name, username, password, team };
                    saveData(MEMBERS_KEY, members);
                }
                
                // åŒæ­¥åˆ°Supabase
                try {
                    const teamId = await getTeamId(team);
                    if (teamId) {
                        const { data, error } = await supabase
                            .from('members')
                            .upsert({
                                name: name,
                                username: username,
                                password: password,
                                team_id: teamId
                            }, { onConflict: 'username' });
                            
                        if (error) {
                            console.error('Supabase åŒæ­¥å¤±è´¥:', error);
                            alert('æˆå‘˜å·²æ›´æ–°åˆ°æœ¬åœ°ï¼Œä½†äº‘ç«¯åŒæ­¥å¤±è´¥');
                        } else {
                            console.log('æˆå‘˜æ•°æ®å·²åŒæ­¥åˆ° Supabase');
                        }
                    }
                } catch (error) {
                    console.error('Supabase åŒæ­¥è¿‡ç¨‹ä¸­å‡ºé”™:', error);
                    alert('æˆå‘˜å·²æ›´æ–°åˆ°æœ¬åœ°ï¼Œä½†äº‘ç«¯åŒæ­¥å‡ºé”™');
                }
                
                // æ¢å¤åŸå§‹çŠ¶æ€
                form.onsubmit = originalSubmit;
                submitBtn.innerHTML = '<span class="icon">â•</span>ãƒ¡ãƒ³ãƒãƒ¼è¿½åŠ ';
                form.reset();
                updateMembersList();
                alert('ãƒ¡ãƒ³ãƒãƒ¼æƒ…å ±ã‚’æ›´æ–°ã—ã¾ã—ãŸï¼');
            };
        }
    </script>
</body>
</html>