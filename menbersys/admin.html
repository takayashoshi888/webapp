<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TKY株式会社 - 管理者パネル</title>
    <link rel="icon" href="http://workbank.page.gd/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="style.css">
    <style>
        /* 管理者パネルの追加スタイル */
        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(135deg, #2c3e50, #4a6491);
            color: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .admin-header h1 {
            margin: 0;
            font-size: 1.5rem;
            font-weight: 600;
            color: white;
        }
        
        .btn-logout {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .btn-logout:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        
        .admin-nav {
            display: flex;
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            margin-bottom: 25px;
        }
        
        .tab-btn {
            flex: 1;
            padding: 15px;
            border: none;
            background: #f8f9fa;
            cursor: pointer;
            font-weight: 600;
            color: #6c757d;
            transition: all 0.3s ease;
            text-align: center;
        }
        
        .tab-btn:hover {
            background: #e9ecef;
        }
        
        .tab-btn.active {
            background: linear-gradient(135deg, #f39c12, #e67e00);
            color: white;
        }
        
        .admin-content {
            background: white;
            border-radius: 10px;
            padding: 25px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        .action-bar {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 20px;
        }
        
        .btn-add {
            background: linear-gradient(135deg, #2ecc71, #27ae60);
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s ease;
        }
        
        .btn-add:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        
        th, td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        
        th {
            background-color: #f8f9fa;
            font-weight: 600;
            color: #495057;
        }
        
        tr:hover {
            background-color: #f8f9fa;
        }
        
        .action-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-right: 5px;
            transition: all 0.2s ease;
        }
        
        .btn-edit {
            background: #f39c12;
            color: white;
        }
        
        .btn-edit:hover {
            background: #e67e22;
        }
        
        .btn-delete {
            background: #e74c3c;
            color: white;
        }
        
        .btn-delete:hover {
            background: #c0392b;
        }
        
        .filter-bar {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 25px;
        }
        
        .filter-bar select, 
        .filter-bar input {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
        }
        
        .btn-export {
            background: linear-gradient(135deg, #9b59b6, #8e44ad);
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            align-self: flex-end;
            transition: all 0.3s ease;
        }
        
        .btn-export:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        
        .excel-style-container {
            overflow-x: auto;
        }
        
        .excel-style-table {
            min-width: 800px;
            border-collapse: collapse;
            margin-bottom: 30px;
        }
        
        .excel-style-table th {
            background: #3498db;
            color: white;
            padding: 15px;
            text-align: center;
        }
        
        .excel-style-table td {
            padding: 12px 15px;
            border: 1px solid #eee;
            text-align: right;
        }
        
        .excel-style-table td:first-child {
            text-align: left;
        }
        
        .excel-style-table tr:nth-child(even) {
            background: #f8f9fa;
        }
        
        .excel-style-table tr:hover {
            background: #e9ecef;
        }
        
        .table-title {
            background: #2c3e50 !important;
            color: white !important;
            font-size: 1.2rem;
        }
        
        /* モーダルスタイル */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: white;
            margin: 5% auto;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            position: relative;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);
        }

        .close {
            position: absolute;
            right: 20px;
            top: 15px;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            color: #7f8c8d;
        }

        .close:hover {
            color: #2c3e50;
        }
        
        .password-change-container {
            max-width: 500px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .password-change-container h2 {
            text-align: center;
            margin-bottom: 30px;
            color: #2c3e50;
        }
        
        .password-change-form {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .password-change-form .form-group {
            margin-bottom: 20px;
        }
        
        .password-change-form label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #495057;
        }
        
        .password-change-form input {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 16px;
            box-sizing: border-box;
        }
        
        .password-change-form input:focus {
            outline: none;
            border-color: #3498db;
            box-shadow: 0 0 0 3px rgba(52, 152, 219, 0.2);
        }
        
        .password-change-form small {
            display: block;
            margin-top: 5px;
            color: #6c757d;
            font-size: 14px;
        }
        
        .password-change-form .btn-submit {
            background: linear-gradient(135deg, #3498db, #2980b9);
            border: none;
            padding: 12px 20px;
            border-radius: 6px;
            color: white;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        
        .password-change-form .btn-submit:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }
        
        .password-change-form .btn-submit:active {
            transform: translateY(0);
        }
        
        @media (max-width: 768px) {
            .admin-header {
                flex-direction: column;
                gap: 15px;
                text-align: center;
            }
            
            .admin-nav {
                flex-direction: column;
            }
            
            .filter-bar {
                flex-direction: column;
            }
            
            .action-bar {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="admin-header">
            <h1 class="logo">TKY株式会社 - 管理者パネル</h1>
            <button id="logout" class="btn-logout">ログアウト</button>
        </header>
        
        <nav class="admin-nav">
            <button class="tab-btn active" data-tab="members">メンバー管理</button>
            <button class="tab-btn" data-tab="teams">チーム管理</button>
            <button class="tab-btn" data-tab="sites">現場管理</button>
            <button class="tab-btn" data-tab="stats">統計</button>
            <button class="tab-btn" data-tab="password">パスワード変更</button>
        </nav>
        
        <main class="admin-content">
            <!-- メンバー管理タブ -->
            <div id="members" class="tab-content active">
                <div class="action-bar">
                    <button id="addMember" class="btn-add">+ メンバー追加</button>
                </div>
                <table id="membersTable">
                    <thead>
                        <tr>
                            <th>氏名</th>
                            <th>チーム</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            
            <!-- チーム管理タブ -->
            <div id="teams" class="tab-content">
                <div class="action-bar">
                    <button id="addTeam" class="btn-add">+ チーム追加</button>
                </div>
                <table id="teamsTable">
                    <thead>
                        <tr>
                            <th>チーム名</th>
                            <th>メンバー数</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            
            <!-- 现場管理タブ -->
            <div id="sites" class="tab-content">
                <div class="action-bar">
                    <button id="addSite" class="btn-add">+ 现場追加</button>
                </div>
                <table id="sitesTable">
                    <thead>
                        <tr>
                            <th>現場名</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            
            <!-- 統計タブ -->
            <div id="stats" class="tab-content">
                <div class="filter-bar">
                    <select id="statsTeamFilter">
                        <option value="all">全チーム</option>
                    </select>
                    <select id="statsSiteFilter">
                        <option value="all">全現場</option>
                        <option value="東京サイト">東京现场</option>
                        <option value="大阪サイト">大阪现场</option>
                        <option value="名古屋サイト">名古屋现场</option>
                    </select>
                    <input type="date" id="statsStartDate">
                    <span>〜</span>
                    <input type="date" id="statsEndDate">
                    <button id="exportData" class="btn-export">データエクスポート</button>
                </div>
                
                <div class="excel-style-container">
                    <table id="siteStats" class="excel-style-table">
                        <thead>
                            <tr>
                                <th colspan="5" class="table-title">現場別統計</th>
                            </tr>
                            <tr>
                                <th>現場名</th>
                                <th>総出勤日数</th>
                                <th>総駐車料金</th>
                                <th>総高速料金</th>
                                <th>総費用</th>
                            </tr>
                        </thead>
                        <tbody id="siteStats"></tbody>
                    </table>
                
                    <table class="excel-style-table">
                        <thead>
                            <tr>
                                <th colspan="5" class="table-title">メンバー別統計</th>
                            </tr>
                            <tr>
                                <th>氏名</th>
                                <th>出勤日数</th>
                                <th>駐車料金合計</th>
                                <th>高速料金合計</th>
                                <th>総費用</th>
                            </tr>
                        </thead>
                        <tbody id="memberStats"></tbody>
                    </table>
                
                    <table class="excel-style-table">
                        <thead>
                            <tr>
                                <th colspan="5" class="table-title">チーム別統計</th>
                            </tr>
                            <tr>
                                <th>チーム名</th>
                                <th>総出勤日数</th>
                                <th>総駐車料金</th>
                                <th>総高速料金</th>
                                <th>総費用</th>
                            </tr>
                        </thead>
                        <tbody id="teamStats"></tbody>
                    </table>
                </div>
            </div>
        </main>
    </div>
    
    <!-- メンバー追加/編集モーダル -->
    <div id="memberModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2 id="modalMemberTitle">メンバー追加</h2>
            <form id="memberForm">
                <input type="hidden" id="memberId">
                <div class="form-group">
                    <label for="memberName">氏名:</label>
                    <input type="text" id="memberName" required>
                </div>
                <div class="form-group">
                    <label for="memberUsername">ユーザー名:</label>
                    <input type="text" id="memberUsername" required>
                </div>
                <div class="form-group">
                    <label for="memberPassword">パスワード:</label>
                    <input type="password" id="memberPassword" required>
                    <small>※半角英数字8文字以上</small>
                </div>
                <div class="form-group">
                    <label for="memberTeam">チーム:</label>
                    <select id="memberTeam" required></select>
                </div>
                <button type="submit" class="btn-submit">保存</button>
            </form>
        </div>
    </div>
    
    <!-- チーム追加モーダル -->
    <div id="teamModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>チーム追加</h2>
            <form id="teamForm">
                <div class="form-group">
                    <label for="teamName">チーム名:</label>
                    <input type="text" id="teamName" required>
                </div>
                <button type="submit" class="btn-submit">保存</button>
            </form>
        </div>
    </div>
    
    <!-- 现場追加/編集モーダル -->
    <div id="siteModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2 id="modalSiteTitle">現場追加</h2>
            <form id="siteForm">
                <input type="hidden" id="siteId">
                <div class="form-group">
                    <label for="siteName">現場名:</label>
                    <input type="text" id="siteName" required>
                </div>
                <button type="submit" class="btn-submit">保存</button>
            </form>
        </div>
    </div>
    
    <!-- パスワード変更タブ -->
    <div id="password" class="tab-content">
        <div class="password-change-container">
            <h2>管理者パスワード変更</h2>
            <form id="passwordChangeForm" class="password-change-form">
                <div class="form-group">
                    <label for="currentPassword">現在のパスワード</label>
                    <input type="password" id="currentPassword" name="currentPassword" required>
                </div>
                
                <div class="form-group">
                    <label for="newPassword">新しいパスワード</label>
                    <input type="password" id="newPassword" name="newPassword" required>
                    <small>※半角英数字8文字以上</small>
                </div>
                
                <div class="form-group">
                    <label for="confirmNewPassword">新しいパスワード（確認）</label>
                    <input type="password" id="confirmNewPassword" name="confirmNewPassword" required>
                </div>
                
                <button type="submit" class="btn-submit">パスワードを変更</button>
            </form>
        </div>
    </div>
    
    <script>
        // データストレージキー
        const STORAGE_KEY = 'tky_attendance_system';
        const MEMBERS_KEY = 'members';
        const TEAMS_KEY = 'teams';
        const ATTENDANCE_KEY = 'attendance';
        const SITES_KEY = 'sites';

        // 初期データ
        const initialData = {
            [MEMBERS_KEY]: [
                { id: 1, name: '山田太郎', team: 'チームA' },
                { id: 2, name: '佐藤花子', team: 'チームB' }
            ],
            [TEAMS_KEY]: ['チームA', 'チームB', 'チームC'],
            [SITES_KEY]: ['東京サイト', '大阪サイト', '名古屋サイト', '渋谷サイト'],
            [ATTENDANCE_KEY]: []
        };

        // データ取得関数
        function getData(key) {
            const data = JSON.parse(localStorage.getItem(STORAGE_KEY)) || initialData;
            return key ? data[key] : data;
        }

        // データ保存関数
        function saveData(key, value) {
            const data = getData();
            data[key] = value;
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        }

        // ログアウト処理
        document.getElementById('logout').addEventListener('click', function() {
            if (confirm('本当にログアウトしますか？')) {
                window.location.href = 'index.html';
            }
        });

        // タブ切り替え
        const tabButtons = document.querySelectorAll('.tab-btn');
        tabButtons.forEach(button => {
            button.addEventListener('click', function() {
                const tabId = this.getAttribute('data-tab');
                
                // アクティブなタブを更新
                tabButtons.forEach(btn => btn.classList.remove('active'));
                this.classList.add('active');
                
                // タブコンテンツを更新
                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                document.getElementById(tabId).classList.add('active');
                
                // タブ固有の初期化
                if (tabId === 'members') {
                    renderMembersTable();
                } else if (tabId === 'teams') {
                    renderTeamsTable();
                } else if (tabId === 'sites') {
                    renderSitesTable();
                } else if (tabId === 'stats') {
                    renderStats();
                }
                // パスワード変更タブは特別な初期化不要
            });
        });

        // メンバー追加ボタン
        document.getElementById('addMember').addEventListener('click', function() {
            document.getElementById('modalMemberTitle').textContent = 'メンバー追加';
            document.getElementById('memberId').value = '';
            document.getElementById('memberName').value = '';
            document.getElementById('memberUsername').value = '';
            document.getElementById('memberPassword').value = '';
            
            // チーム選択肢を更新
            const teamSelect = document.getElementById('memberTeam');
            teamSelect.innerHTML = '';
            getData(TEAMS_KEY).forEach(team => {
                const option = document.createElement('option');
                option.value = team;
                option.textContent = team;
                teamSelect.appendChild(option);
            });
            
            document.getElementById('memberModal').style.display = 'block';
        });

        // チーム追加ボタン
        document.getElementById('addTeam').addEventListener('click', function() {
            document.getElementById('teamName').value = '';
            document.getElementById('teamModal').style.display = 'block';
        });

        // モーダル閉じるボタン
        document.querySelectorAll('.close').forEach(closeBtn => {
            closeBtn.addEventListener('click', function() {
                this.closest('.modal').style.display = 'none';
            });
        });

        // ウィンドウ外クリックでモーダルを閉じる
        window.addEventListener('click', function(e) {
            if (e.target.classList.contains('modal')) {
                e.target.style.display = 'none';
            }
        });

        // メンバーフォーム送信
        document.getElementById('memberForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const id = document.getElementById('memberId').value;
            const name = document.getElementById('memberName').value;
            const username = document.getElementById('memberUsername').value;
            const password = document.getElementById('memberPassword').value;
            const team = document.getElementById('memberTeam').value;
            
            // パスワード長さ確認
            if (password && password.length < 8) {
                alert('パスワードは8文字以上である必要があります');
                return;
            }
            
            const members = getData(MEMBERS_KEY);
            
            if (id) {
                // 既存メンバーを更新
                const index = members.findIndex(m => m.id == id);
                if (index !== -1) {
                    members[index] = { id: parseInt(id), name, team };
                }
                
                // ユーザー名とパスワードが入力されている場合、registeredUsersにも更新
                if (username && password) {
                    let users = JSON.parse(localStorage.getItem('registeredUsers')) || [];
                    
                    // 既存のユーザー情報を更新または新規追加
                    const userIndex = users.findIndex(user => user.name === name && user.team === team);
                    if (userIndex !== -1) {
                        // 既存ユーザーを更新
                        users[userIndex] = { username, password, name, team };
                    } else {
                        // 新しいユーザーを追加
                        // ユーザー名の重複チェック
                        if (users.some(user => user.username === username)) {
                            alert('このユーザー名は既に使用されています');
                            return;
                        }
                        users.push({ username, password, name, team });
                    }
                    
                    // ローカルストレージに保存
                    localStorage.setItem('registeredUsers', JSON.stringify(users));
                }
            } else {
                // 新しいメンバーを追加
                const newId = members.length > 0 ? Math.max(...members.map(m => m.id)) + 1 : 1;
                members.push({ id: newId, name, team });
                
                // ユーザー名の重複チェックと登録
                if (username && password) {
                    let users = JSON.parse(localStorage.getItem('registeredUsers')) || [];
                    
                    // ユーザー名が既に存在するかチェック
                    if (users.some(user => user.username === username)) {
                        alert('このユーザー名は既に使用されています');
                        return;
                    }
                    
                    // 新しいユーザーを追加
                    users.push({ username, password, name, team });
                    
                    // ローカルストレージに保存
                    localStorage.setItem('registeredUsers', JSON.stringify(users));
                }
            }
            
            saveData(MEMBERS_KEY, members);
            document.getElementById('memberModal').style.display = 'none';
            renderMembersTable();
        });

        // チームフォーム送信
        document.getElementById('teamForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const teamName = document.getElementById('teamName').value;
            const teams = getData(TEAMS_KEY);
            
            if (!teams.includes(teamName)) {
                teams.push(teamName);
                saveData(TEAMS_KEY, teams);
                document.getElementById('teamModal').style.display = 'none';
                renderTeamsTable();
            } else {
                alert('このチーム名は既に存在します');
            }
        });

        // メンバーテーブルをレンダリング
        function renderMembersTable() {
            const members = getData(MEMBERS_KEY);
            const teams = getData(TEAMS_KEY);
            const tbody = document.querySelector('#membersTable tbody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            members.forEach(member => {
                const row = document.createElement('tr');
                
                row.innerHTML = `
                    <td>${member.name}</td>
                    <td>${member.team}</td>
                    <td>
                        <button class="action-btn btn-edit" data-id="${member.id}">編集</button>
                        <button class="action-btn btn-delete" data-id="${member.id}">削除</button>
                    </td>
                `;
                
                tbody.appendChild(row);
            });
            
            // 編集ボタン
            document.querySelectorAll('#membersTable .btn-edit').forEach(btn => {
                btn.addEventListener('click', function() {
                    const id = this.getAttribute('data-id');
                    const member = getData(MEMBERS_KEY).find(m => m.id == id);
                    
                    if (member) {
                        document.getElementById('modalMemberTitle').textContent = 'メンバー編集';
                        document.getElementById('memberId').value = member.id;
                        document.getElementById('memberName').value = member.name;
                        
                        // ユーザー名とパスワードフィールドをクリア
                        document.getElementById('memberUsername').value = '';
                        document.getElementById('memberPassword').value = '';
                        
                        // チーム選択肢を更新
                        const teamSelect = document.getElementById('memberTeam');
                        teamSelect.innerHTML = '';
                        teams.forEach(team => {
                            const option = document.createElement('option');
                            option.value = team;
                            option.textContent = team;
                            option.selected = team === member.team;
                            teamSelect.appendChild(option);
                        });
                        
                        document.getElementById('memberModal').style.display = 'block';
                    }
                });
            });
            
            // 削除ボタン
            document.querySelectorAll('#membersTable .btn-delete').forEach(btn => {
                btn.addEventListener('click', function() {
                    if (confirm('このメンバーを削除しますか？')) {
                        const id = this.getAttribute('data-id');
                        const members = getData(MEMBERS_KEY).filter(m => m.id != id);
                        saveData(MEMBERS_KEY, members);
                        renderMembersTable();
                    }
                });
            });
        }

        // チームテーブルをレンダリング
        function renderTeamsTable() {
            const teams = getData(TEAMS_KEY);
            const members = getData(MEMBERS_KEY);
            const tbody = document.querySelector('#teamsTable tbody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            teams.forEach(team => {
                const memberCount = members.filter(m => m.team === team).length;
                
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${team}</td>
                    <td>${memberCount}</td>
                    <td>
                        <button class="action-btn btn-edit" data-team="${team}">編集</button>
                        <button class="action-btn btn-delete" data-team="${team}">削除</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            
            // チーム編集ボタン
            document.querySelectorAll('#teamsTable .btn-edit').forEach(btn => {
                btn.addEventListener('click', function() {
                    const oldTeamName = this.getAttribute('data-team');
                    const newTeamName = prompt('新しいチーム名を入力してください', oldTeamName);
                    
                    if (newTeamName && newTeamName !== oldTeamName) {
                        if (getData(TEAMS_KEY).includes(newTeamName)) {
                            alert('このチーム名は既に存在します');
                            return;
                        }
                        
                        // 更新团队名称
                        const teams = getData(TEAMS_KEY).map(t => t === oldTeamName ? newTeamName : t);
                        saveData(TEAMS_KEY, teams);
                        
                        // 更新关联成员
                        const members = getData(MEMBERS_KEY).map(m => {
                            if (m.team === oldTeamName) {
                                return {...m, team: newTeamName};
                            }
                            return m;
                        });
                        saveData(MEMBERS_KEY, members);
                        
                        renderTeamsTable();
                        renderMembersTable();
                    }
                });
            });
            
            // チーム削除ボタン
            document.querySelectorAll('#teamsTable .btn-delete').forEach(btn => {
                btn.addEventListener('click', function() {
                    const team = this.getAttribute('data-team');
                    const membersInTeam = getData(MEMBERS_KEY).filter(m => m.team === team).length;
                    
                    if (membersInTeam > 0) {
                        alert('このチームにはメンバーが存在するため削除できません');
                        return;
                    }
                    
                    if (confirm(`チーム「${team}」を削除しますか？`)) {
                        const teams = getData(TEAMS_KEY).filter(t => t !== team);
                        saveData(TEAMS_KEY, teams);
                        renderTeamsTable();
                    }
                });
            });
        }

        // 现場管理テーブルをレンダリング
        function renderSitesTable() {
            const sites = getData(SITES_KEY);
            const tbody = document.querySelector('#sitesTable tbody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            
            sites.forEach((site, index) => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${site}</td>
                    <td>
                        <button class="action-btn btn-edit" onclick="editSite(${index})">編集</button>
                        <button class="action-btn btn-delete" onclick="deleteSite(${index})">削除</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
        }

        // 现場編集
        function editSite(index) {
            const sites = getData(SITES_KEY);
            const siteName = sites[index];
            document.getElementById('siteId').value = index;
            document.getElementById('siteName').value = siteName;
            document.getElementById('modalSiteTitle').textContent = '現場編集';
            document.getElementById('siteModal').style.display = 'block';
        }

        // 现場削除
        function deleteSite(index) {
            const sites = getData(SITES_KEY);
            const siteName = sites[index];
            
            if (confirm(`本当に現場「${siteName}」を削除しますか？`)) {
                sites.splice(index, 1);
                saveData(SITES_KEY, sites);
                renderSitesTable();
            }
        }

        // 現場フォーム送信
        document.getElementById('siteForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const siteId = document.getElementById('siteId').value;
            const siteName = document.getElementById('siteName').value.trim();
            const sites = getData(SITES_KEY);
            
            if (siteId !== '') {
                // 編集
                sites[parseInt(siteId)] = siteName;
            } else {
                // 追加
                if (!sites.includes(siteName)) {
                    sites.push(siteName);
                } else {
                    alert('この現場名は既に存在します');
                    return;
                }
            }
            
            saveData(SITES_KEY, sites);
            document.getElementById('siteModal').style.display = 'none';
            renderSitesTable();
        });

        // 現場追加ボタン
        document.getElementById('addSite').addEventListener('click', function() {
            document.getElementById('siteId').value = '';
            document.getElementById('siteName').value = '';
            document.getElementById('modalSiteTitle').textContent = '現場追加';
            document.getElementById('siteModal').style.display = 'block';
        });

        // 統計データをレンダリング
        function renderStats() {
            const attendance = getData(ATTENDANCE_KEY) || [];
            
            // 現場別統計
            const siteStats = {};
            const sites = getData(SITES_KEY);
            sites.forEach(site => {
                siteStats[site] = { days: 0, parkingFee: 0, highwayFee: 0, total: 0 };
            });

            attendance.forEach(record => {
                if (siteStats[record.site]) {
                    siteStats[record.site].days++;
                    siteStats[record.site].parkingFee += record.parkingFee;
                    siteStats[record.site].highwayFee += record.highwayFee;
                    siteStats[record.site].total += record.parkingFee + record.highwayFee;
                }
            });

            const siteStatsTbody = document.querySelector('#siteStats tbody');
            if (siteStatsTbody) {
                siteStatsTbody.innerHTML = '';
                Object.entries(siteStats).forEach(([site, stats]) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${site}</td>
                        <td>${stats.days}</td>
                        <td>${stats.parkingFee.toLocaleString()} 円</td>
                        <td>${stats.highwayFee.toLocaleString()} 円</td>
                        <td>${stats.total.toLocaleString()} 円</td>
                    `;
                    siteStatsTbody.appendChild(row);
                });
            }

            // メンバー別統計
            const memberStats = {};
            attendance.forEach(record => {
                if (!memberStats[record.name]) {
                    memberStats[record.name] = {
                        days: 0,
                        parkingFee: 0,
                        highwayFee: 0,
                        total: 0
                    };
                }
                memberStats[record.name].days++;
                memberStats[record.name].parkingFee += record.parkingFee;
                memberStats[record.name].highwayFee += record.highwayFee;
                memberStats[record.name].total += record.parkingFee + record.highwayFee;
            });

            const memberStatsTbody = document.getElementById('memberStats');
            if (memberStatsTbody) {
                memberStatsTbody.innerHTML = '';
                Object.entries(memberStats).forEach(([name, stats]) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${name}</td>
                        <td>${stats.days}</td>
                        <td>${stats.parkingFee.toLocaleString()} 円</td>
                        <td>${stats.highwayFee.toLocaleString()} 円</td>
                        <td>${stats.total.toLocaleString()} 円</td>
                    `;
                    memberStatsTbody.appendChild(row);
                });
            }

            // チーム別統計
            const teamStats = {};
            attendance.forEach(record => {
                if (!teamStats[record.team]) {
                    teamStats[record.team] = {
                        days: 0,
                        parkingFee: 0,
                        highwayFee: 0,
                        total: 0
                    };
                }
                teamStats[record.team].days++;
                teamStats[record.team].parkingFee += record.parkingFee;
                teamStats[record.team].highwayFee += record.highwayFee;
                teamStats[record.team].total += record.parkingFee + record.highwayFee;
            });

            const teamStatsTbody = document.getElementById('teamStats');
            if (teamStatsTbody) {
                teamStatsTbody.innerHTML = '';
                Object.entries(teamStats).forEach(([team, stats]) => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${team}</td>
                        <td>${stats.days}</td>
                        <td>${stats.parkingFee.toLocaleString()} 円</td>
                        <td>${stats.highwayFee.toLocaleString()} 円</td>
                        <td>${stats.total.toLocaleString()} 円</td>
                    `;
                    teamStatsTbody.appendChild(row);
                });
            }
        }

        // データエクスポート
        document.getElementById('exportData').addEventListener('click', function() {
            const attendance = getData(ATTENDANCE_KEY) || [];
            if (!attendance.length) {
                alert('エクスポートするデータがありません');
                return;
            }
            
            // CSVデータを生成
            let csv = '日付,現場名,チーム,氏名,駐車料金,高速料金,合計\n';
            attendance.forEach(record => {
                csv += `${record.date},${record.site},${record.team},${record.name},${record.parkingFee},${record.highwayFee},${record.parkingFee + record.highwayFee}\n`;
            });
            
            // ファイル名を生成
            const now = new Date();
            const timestamp = `${now.getFullYear()}${(now.getMonth()+1).toString().padStart(2, '0')}${now.getDate().toString().padStart(2, '0')}_${now.getHours().toString().padStart(2, '0')}`;
            const filename = `出勤データ_${timestamp}.csv`;
            
            // ダウンロード
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = filename;
            link.click();
        });

        // パスワード変更フォーム送信
        document.getElementById('passwordChangeForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmNewPassword = document.getElementById('confirmNewPassword').value;
            
            // 現在のパスワードを検証
            // 実際のアプリでは、サーバー側で認証を行うべきですが、
            // ここでは簡単のためにローカルストレージに保存されたパスワードをチェックします
            const adminPassword = localStorage.getItem('adminPassword') || 'admin123';
            
            if (currentPassword !== adminPassword) {
                alert('現在のパスワードが正しくありません');
                return;
            }
            
            // 新しいパスワードの確認
            if (newPassword !== confirmNewPassword) {
                alert('新しいパスワードが一致しません');
                return;
            }
            
            // パスワード長さ確認
            if (newPassword.length < 8) {
                alert('新しいパスワードは8文字以上である必要があります');
                return;
            }
            
            // 新しいパスワードを保存
            localStorage.setItem('adminPassword', newPassword);
            
            // フォームをリセット
            document.getElementById('passwordChangeForm').reset();
            
            alert('パスワードが正常に変更されました');
        });

        // 初期表示
        renderMembersTable();
        renderTeamsTable();
        renderSitesTable();
    </script>
</body>
</html>