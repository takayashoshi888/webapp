<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TKY株式会社 - 管理者パネル</title>
    <link rel="icon" href="favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <div class="responsive-wrapper">
            <header class="app-header">
                <div class="header-content">
                    <div class="logo-section">
                        <div class="logo-badge">
                            <span class="logo-initial">TKY</span>
                        </div>
                        <div class="logo-text">
                            <h1 class="company-name">TKY株式会社</h1>
                            <p class="system-title">管理者パネル</p>
                        </div>
                    </div>
                    <div class="header-actions">
                        <button id="backToMain" class="back-btn">
                            <span class="icon">←</span>
                            メイン画面へ戻る
                        </button>
                    </div>
                </div>
            </header>
            
            <!-- Supabase 连接状态提示 -->
            <div id="supabaseStatus" style="margin: 10px 20px; padding: 10px; border-radius: 5px; display: none;"></div>
            
            <main class="main-content">
                <div class="form-card">
                    <div class="card-header">
                        <h2 class="form-title">メンバー管理</h2>
                        <p class="form-subtitle">メンバーの追加・編集・削除ができます</p>
                    </div>
                    
                    <form id="memberForm" class="member-form">
                        <div class="form-group">
                            <label for="memberName" class="form-label">氏名</label>
                            <input type="text" id="memberName" class="form-input" required placeholder="氏名を入力">
                        </div>
                        
                        <div class="form-group">
                            <label for="username" class="form-label">ユーザー名</label>
                            <input type="text" id="username" class="form-input" required placeholder="ユーザー名を入力">
                        </div>
                        
                        <div class="form-group">
                            <label for="password" class="form-label">パスワード</label>
                            <input type="password" id="password" class="form-input" required placeholder="パスワードを入力">
                        </div>
                        
                        <div class="form-group">
                            <label for="team" class="form-label">チーム</label>
                            <select id="team" class="form-select" required>
                                <option value="">選択してください</option>
                            </select>
                        </div>
                        
                        <div class="form-actions">
                            <button type="submit" class="submit-btn">
                                <span class="icon">➕</span>
                                メンバー追加
                            </button>
                            <button type="button" id="clearForm" class="clear-btn">
                                <span class="icon">🗑️</span>
                                クリア
                            </button>
                        </div>
                    </form>
                </div>
                
                <div class="members-list">
                    <h3 class="list-title">登録済みメンバー</h3>
                    <div id="membersContainer" class="members-container">
                        <!-- メンバーリストがここに表示されます -->
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <!-- 加载 Supabase CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Supabase 配置
        const supabaseUrl = 'https://xhqvbirifrdlmlnrwayp.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhocXZiaXJpZnJkbG1sbnJ3YXlwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA1MTYzNzQsImV4cCI6MjA3NjA5MjM3NH0.CFLPI0sTrO5CYezI2BZRPyaLFS_A7NdxBbZ08qpTlVc';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        // 数据存储键
        const STORAGE_KEY = 'tky_attendance_system';
        const MEMBERS_KEY = 'members';
        const TEAMS_KEY = 'teams';
        const SITES_KEY = 'sites';

        // 初期データ
        const initialData = {
            [MEMBERS_KEY]: [
                { id: 1, name: '山田太郎', team: 'チームA' },
                { id: 2, name: '佐藤花子', team: 'チームB' }
            ],
            [TEAMS_KEY]: ['チームA', 'チームB', 'チームC'],
            [SITES_KEY]: ['東京サイト', '大阪サイト', '名古屋サイト', '渋谷サイト']
        };

        // データ取得関数
        function getData(key) {
            const data = JSON.parse(localStorage.getItem(STORAGE_KEY)) || initialData;
            return key ? data[key] : data;
        }

        // データ保存関数
        function saveData(key, value) {
            const data = getData();
            data[key] = value;
            localStorage.setItem(STORAGE_KEY, JSON.stringify(data));
        }

        // 数据映射辅助函数
        let teamMap = null;

        // 获取团队ID
        async function getTeamId(teamName) {
            if (!teamMap) {
                const { data, error } = await supabase.from('teams').select('id, name');
                if (!error) {
                    teamMap = Object.fromEntries(data.map(t => [t.name, t.id]));
                } else {
                    console.error('获取团队数据失败:', error);
                    return null;
                }
            }
            return teamMap?.[teamName] || null;
        }

        // 页面加载时测试 Supabase 连接
        document.addEventListener('DOMContentLoaded', async function() {
            const statusDiv = document.getElementById('supabaseStatus');
            
            try {
                // 测试连接 - 尝试获取一个简单的查询
                const { data, error } = await supabase
                    .from('teams')
                    .select('id')
                    .limit(1);
                
                if (error) {
                    throw error;
                }
                
                // 显示成功连接消息
                statusDiv.style.display = 'block';
                statusDiv.style.backgroundColor = '#d4edda';
                statusDiv.style.color = '#155724';
                statusDiv.style.border = '1px solid #c3e6cb';
                statusDiv.innerHTML = '✅ 成功连接云端数据库 (Supabase)';
                
            } catch (error) {
                // 连接失败时显示错误消息
                console.log('Supabase 连接测试失败:', error.message);
                statusDiv.style.display = 'block';
                statusDiv.style.backgroundColor = '#f8d7da';
                statusDiv.style.color = '#721c24';
                statusDiv.style.border = '1px solid #f5c6cb';
                statusDiv.innerHTML = `❌ 数据库连接失败: ${error.message}`;
            }
            
            // 初始化页面功能
            initializePage();
        });

        // 初始化页面功能
        function initializePage() {
            // 团队选择项更新
            const teamSelect = document.getElementById('team');
            teamSelect.innerHTML = '<option value="">選択してください</option>';
            getData(TEAMS_KEY).forEach(team => {
                const option = document.createElement('option');
                option.value = team;
                option.textContent = team;
                teamSelect.appendChild(option);
            });

            // 返回主页面按钮
            document.getElementById('backToMain').addEventListener('click', function() {
                window.location.href = 'index.html';
            });

            // 成员表单提交
            document.getElementById('memberForm').addEventListener('submit', async function(e) {
                e.preventDefault();

                const name = document.getElementById('memberName').value;
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;
                const team = document.getElementById('team').value;

                // 信息确认
                const confirmMsg = 
                    `以下の内容でメンバーを追加します。\n\n` +
                    `氏名: ${name}\n` +
                    `ユーザー名: ${username}\n` +
                    `チーム: ${team}\n\n` +
                    `よろしいですか？`;
                if (!window.confirm(confirmMsg)) {
                    return;
                }

                // 保存到本地存储
                const members = getData(MEMBERS_KEY);
                const newMember = {
                    id: Date.now(),
                    name: name,
                    username: username,
                    password: password,
                    team: team
                };
                members.push(newMember);
                saveData(MEMBERS_KEY, members);

                // 同步到Supabase
                try {
                    const teamId = await getTeamId(team);
                    if (teamId) {
                        const { data, error } = await supabase
                            .from('members')
                            .upsert({
                                name: name,
                                username: username,
                                password: password,
                                team_id: teamId
                            }, { onConflict: 'username' });
                            
                        if (error) {
                            console.error('Supabase 同步失败:', error);
                            alert('成员已保存到本地，但云端同步失败');
                        } else {
                            console.log('成员数据已同步到 Supabase');
                        }
                    } else {
                        console.warn('无法找到对应的团队ID，跳过Supabase同步');
                        alert('成员已保存到本地，但云端同步需要团队映射');
                    }
                } catch (error) {
                    console.error('Supabase 同步过程中出错:', error);
                    alert('成员已保存到本地，但云端同步出错');
                }

                // 更新成员列表
                updateMembersList();
                
                // 表单重置
                this.reset();
                alert('メンバーが追加されました！');
            });

            // 清除表单按钮
            document.getElementById('clearForm').addEventListener('click', function() {
                document.getElementById('memberForm').reset();
            });

            // 初始化成员列表
            updateMembersList();
        }

        // 更新成员列表
        function updateMembersList() {
            const members = getData(MEMBERS_KEY);
            const container = document.getElementById('membersContainer');
            
            container.innerHTML = '';
            
            if (members.length === 0) {
                container.innerHTML = '<p class="no-members">登録されているメンバーはいません</p>';
                return;
            }
            
            members.forEach(member => {
                const memberElement = document.createElement('div');
                memberElement.className = 'member-item';
                memberElement.innerHTML = `
                    <div class="member-info">
                        <strong>${member.name}</strong> (${member.username})
                        <span class="member-team">${member.team}</span>
                    </div>
                    <div class="member-actions">
                        <button class="edit-btn" data-id="${member.id}">編集</button>
                        <button class="delete-btn" data-id="${member.id}">削除</button>
                    </div>
                `;
                container.appendChild(memberElement);
            });

            // 添加删除事件监听器
            document.querySelectorAll('.delete-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const memberId = parseInt(this.getAttribute('data-id'));
                    deleteMember(memberId);
                });
            });

            // 添加编辑事件监听器
            document.querySelectorAll('.edit-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const memberId = parseInt(this.getAttribute('data-id'));
                    editMember(memberId);
                });
            });
        }

        // 删除成员
        function deleteMember(memberId) {
            if (!confirm('このメンバーを削除してもよろしいですか？')) {
                return;
            }
            
            const members = getData(MEMBERS_KEY);
            const updatedMembers = members.filter(member => member.id !== memberId);
            saveData(MEMBERS_KEY, updatedMembers);
            updateMembersList();
            alert('メンバーを削除しました');
        }

        // 编辑成员
        function editMember(memberId) {
            const members = getData(MEMBERS_KEY);
            const member = members.find(m => m.id === memberId);
            
            if (!member) return;
            
            // 填充表单
            document.getElementById('memberName').value = member.name;
            document.getElementById('username').value = member.username;
            document.getElementById('password').value = member.password;
            document.getElementById('team').value = member.team;
            
            // 修改提交按钮文本
            const submitBtn = document.querySelector('#memberForm .submit-btn');
            submitBtn.innerHTML = '<span class="icon">✏️</span>メンバー更新';
            
            // 临时修改提交事件
            const form = document.getElementById('memberForm');
            const originalSubmit = form.onsubmit;
            
            form.onsubmit = async function(e) {
                e.preventDefault();
                
                const name = document.getElementById('memberName').value;
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;
                const team = document.getElementById('team').value;
                
                // 更新本地存储
                const members = getData(MEMBERS_KEY);
                const memberIndex = members.findIndex(m => m.id === memberId);
                if (memberIndex !== -1) {
                    members[memberIndex] = { ...members[memberIndex], name, username, password, team };
                    saveData(MEMBERS_KEY, members);
                }
                
                // 同步到Supabase
                try {
                    const teamId = await getTeamId(team);
                    if (teamId) {
                        const { data, error } = await supabase
                            .from('members')
                            .upsert({
                                name: name,
                                username: username,
                                password: password,
                                team_id: teamId
                            }, { onConflict: 'username' });
                            
                        if (error) {
                            console.error('Supabase 同步失败:', error);
                            alert('成员已更新到本地，但云端同步失败');
                        } else {
                            console.log('成员数据已同步到 Supabase');
                        }
                    }
                } catch (error) {
                    console.error('Supabase 同步过程中出错:', error);
                    alert('成员已更新到本地，但云端同步出错');
                }
                
                // 恢复原始状态
                form.onsubmit = originalSubmit;
                submitBtn.innerHTML = '<span class="icon">➕</span>メンバー追加';
                form.reset();
                updateMembersList();
                alert('メンバー情報を更新しました！');
            };
        }
    </script>
</body>
</html>