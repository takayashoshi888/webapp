<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TKYæ ªå¼ä¼šç¤¾ - ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ‡ãƒ¼ã‚¿</title>
    <link rel="icon" href="http://workbank.page.gd/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <div class="responsive-wrapper">
            <header class="app-header">
                <div class="header-content">
                    <div class="logo-section">
                        <div class="logo-badge">
                            <span class="logo-initial">TKY</span>
                        </div>
                        <div class="logo-text">
                            <h1 class="company-name">TKYæ ªå¼ä¼šç¤¾</h1>
                            <p class="system-title">å‡ºå‹¤ç®¡ç†ã‚·ã‚¹ãƒ†ãƒ </p>
                        </div>
                    </div>
                    <div class="header-actions">
                        <button id="logout" class="admin-login-btn">
                            <span class="icon">ğŸšª</span>
                            ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ
                        </button>
                    </div>
                </div>
            </header>
            
            <!-- Supabase è¿æ¥çŠ¶æ€æç¤º -->
            <div id="supabaseStatus" style="margin: 10px 20px; padding: 10px; border-radius: 5px; display: none;"></div>
            
            <main class="main-content">
                <div class="form-card">
                    <div class="card-header">
                        <h2 class="form-title">ã‚ãªãŸã®å‡ºå‹¤ãƒ‡ãƒ¼ã‚¿</h2>
                        <p class="form-subtitle">ã“ã“ã§ã¯ã€ã‚ãªãŸã®å‡ºå‹¤æƒ…å ±ã‚’ç¢ºèªã§ãã¾ã™</p>
                    </div>
                    
                    <div class="info-section">
                        <div class="info-card">
                            <h3 class="info-title">å€‹äººæƒ…å ±</h3>
                            <div class="info-item">
                                <span class="info-label">æ°å:</span>
                                <span class="info-value" id="userName"></span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="info-section">
                        <div class="info-card">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                <h3 class="info-title">å‡ºå‹¤è¨˜éŒ²</h3>
                                <button id="exportData" class="btn-export">
                                    <span class="icon">ğŸ’¾</span>
                                    ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
                                </button>
                            </div>
                            <div class="table-container">
                                <table id="attendanceTable" class="excel-style-table">
                                    <thead>
                                        <tr>
                                            <th>æ—¥ä»˜</th>
                                            <th>ç¾å ´å</th>
                                            <th>ãƒãƒ¼ãƒ </th>
                                            <th>é§è»Šæ–™é‡‘</th>
                                            <th>é«˜é€Ÿæ–™é‡‘</th>
                                            <th>åˆè¨ˆ</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- å‡ºå‹¤ãƒ‡ãƒ¼ã‚¿ãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <script type="module">
        // å¯¼å…¥ Supabase å®¢æˆ·ç«¯
        import { supabase } from './js/supabaseClient.js';
        
        // é¡µé¢åŠ è½½æ—¶æµ‹è¯• Supabase è¿æ¥
        document.addEventListener('DOMContentLoaded', async function() {
            const statusDiv = document.getElementById('supabaseStatus');
            
            try {
                // æµ‹è¯•è¿æ¥ - å°è¯•è·å–ä¸€ä¸ªç®€å•çš„æŸ¥è¯¢
                const { data, error } = await supabase
                    .from('attendance_records')
                    .select('id')
                    .limit(1);
                
                if (error) {
                    throw error;
                }
                
                // æ˜¾ç¤ºæˆåŠŸè¿æ¥æ¶ˆæ¯
                statusDiv.style.display = 'block';
                statusDiv.style.backgroundColor = '#d4edda';
                statusDiv.style.color = '#155724';
                statusDiv.style.border = '1px solid #c3e6cb';
                statusDiv.innerHTML = 'âœ… æˆåŠŸè¿æ¥äº‘ç«¯æ•°æ®åº“ (Supabase)';
                
            } catch (error) {
                // è¿æ¥å¤±è´¥æ—¶ä¸æ˜¾ç¤ºé”™è¯¯ï¼Œé¿å…å½±å“ç”¨æˆ·ä½“éªŒ
                console.log('Supabase è¿æ¥ãƒ†ã‚¹ãƒˆå¤±è´¥:', error.message);
                statusDiv.style.display = 'none';
            }
            
            // åˆå§‹åŒ–åŸæœ‰çš„ç”¨æˆ·æ•°æ®åŠŸèƒ½
            initializeUserData();
        });
        
        // åˆå§‹åŒ–ç”¨æˆ·ãƒ‡ãƒ¼ã‚¿æ©Ÿèƒ½ã®å‡½æ•°
        function initializeUserData() {
            // ãƒ‡ãƒ¼ã‚¿å­˜å‚¨ã‚­ãƒ¼
            const STORAGE_KEY = 'tky_attendance_system';
            const ATTENDANCE_KEY = 'attendance';

            // ãƒ‡ãƒ¼ã‚¿å–å¾—é–¢æ•°
            function getData(key) {
                const data = JSON.parse(localStorage.getItem(STORAGE_KEY)) || {};
                return key ? data[key] : data;
            }

            // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚
            // ãƒ­ã‚°ã‚¤ãƒ³çŠ¶æ…‹ã‚’ãƒã‚§ãƒƒã‚¯
            let currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
            if (!currentUser) {
                // å¦‚æœsessionStorageä¸­æ²¡æœ‰ï¼Œå°è¯•ä»localStorageè·å–ï¼ˆå‘åå…¼å®¹ï¼‰
                currentUser = JSON.parse(localStorage.getItem('currentUser'));
                if (currentUser) {
                    // å¦‚æœåœ¨localStorageä¸­æ‰¾åˆ°ï¼Œå°†å…¶ç§»åŠ¨åˆ°sessionStorage
                    sessionStorage.setItem('currentUser', JSON.stringify(currentUser));
                    localStorage.removeItem('currentUser');
                }
            }
            
            if (!currentUser) {
                window.location.href = 'index.html';
                return;
            }
            
            // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ã‚’è¡¨ç¤º
            document.getElementById('userName').textContent = currentUser.name;
            
            // å‡ºå‹¤ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤º
            renderAttendanceData(currentUser.name);
            
            // å‡ºå‹¤ãƒ‡ãƒ¼ã‚¿ã‚’è¡¨ç¤º
            function renderAttendanceData(userName) {
                const attendanceData = getData(ATTENDANCE_KEY) || [];
                const userAttendance = attendanceData.filter(record => record.name === userName);
                
                const tbody = document.querySelector('#attendanceTable tbody');
                tbody.innerHTML = '';
                
                let totalParkingFee = 0;
                let totalHighwayFee = 0;
                
                userAttendance.forEach(record => {
                    const row = document.createElement('tr');
                    const total = record.parkingFee + record.highwayFee;
                    totalParkingFee += record.parkingFee;
                    totalHighwayFee += record.highwayFee;
                    
                    row.innerHTML = `
                        <td>${record.date}</td>
                        <td>${record.site}</td>
                        <td>${record.team}</td>
                        <td>${record.parkingFee.toLocaleString()} å††</td>
                        <td>${record.highwayFee.toLocaleString()} å††</td>
                        <td>${total.toLocaleString()} å††</td>
                    `;
                    tbody.appendChild(row);
                });
                
                // åˆè¨ˆè¡Œã‚’è¿½åŠ 
                if (userAttendance.length > 0) {
                    const totalRow = document.createElement('tr');
                    totalRow.innerHTML = `
                        <td colspan="3"><strong>åˆè¨ˆ</strong></td>
                        <td><strong>${totalParkingFee.toLocaleString()} å††</strong></td>
                        <td><strong>${totalHighwayFee.toLocaleString()} å††</strong></td>
                        <td><strong>${(totalParkingFee + totalHighwayFee).toLocaleString()} å††</strong></td>
                    `;
                    tbody.appendChild(totalRow);
                } else {
                    const noDataRow = document.createElement('tr');
                    noDataRow.innerHTML = `<td colspan="6">å‡ºå‹¤ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</td>`;
                    tbody.appendChild(noDataRow);
                }
            }
            
            // ãƒ‡ãƒ¼ã‚¿ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ
            document.getElementById('exportData').addEventListener('click', function() {
                const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
                if (!currentUser) {
                    alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                    return;
                }
                
                const attendanceData = getData(ATTENDANCE_KEY) || [];
                const userAttendance = attendanceData.filter(record => record.name === currentUser.name);
                
                if (userAttendance.length === 0) {
                    alert('ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
                    return;
                }
                
                // CSVãƒ‡ãƒ¼ã‚¿ã‚’ç”Ÿæˆ
                let csv = 'æ—¥ä»˜,ç¾å ´å,ãƒãƒ¼ãƒ ,é§è»Šæ–™é‡‘,é«˜é€Ÿæ–™é‡‘,åˆè¨ˆ\n';
                userAttendance.forEach(record => {
                    const total = record.parkingFee + record.highwayFee;
                    csv += `${record.date},${record.site},${record.team},${record.parkingFee},${record.highwayFee},${total}\n`;
                });
                
                // ãƒ•ã‚¡ã‚¤ãƒ«åã‚’ç”Ÿæˆ
                const now = new Date();
                const timestamp = `${now.getFullYear()}${(now.getMonth()+1).toString().padStart(2, '0')}${now.getDate().toString().padStart(2, '0')}_${now.getHours().toString().padStart(2, '0')}`;
                const filename = `å‡ºå‹¤ãƒ‡ãƒ¼ã‚¿_${currentUser.name}_${timestamp}.csv`;
                
                // ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = filename;
                link.click();
            });
            
            // ãƒ­ã‚°ã‚¢ã‚¦ãƒˆå‡¦ç†
            document.getElementById('logout').addEventListener('click', function() {
                if (confirm('æœ¬å½“ã«ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ')) {
                    sessionStorage.removeItem('currentUser');
                    window.location.href = 'index.html';
                }
            });
        }
    </script>
</body>
</html>