<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TKYÊ†™Âºè‰ºöÁ§æ - „É¶„Éº„Ç∂„Éº„Éá„Éº„Çø</title>
    <link rel="icon" href="http://workbank.page.gd/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <div class="responsive-wrapper">
            <header class="app-header">
                <div class="header-content">
                    <div class="logo-section">
                        <div class="logo-badge">
                            <span class="logo-initial">TKY</span>
                        </div>
                        <div class="logo-text">
                            <h1 class="company-name">TKYÊ†™Âºè‰ºöÁ§æ</h1>
                            <p class="system-title">Âá∫Âã§ÁÆ°ÁêÜ„Ç∑„Çπ„ÉÜ„É†</p>
                        </div>
                    </div>
                    <div class="header-actions">
                        <button id="logout" class="admin-login-btn">
                            <span class="icon">üö™</span>
                            „É≠„Ç∞„Ç¢„Ç¶„Éà
                        </button>
                    </div>
                </div>
            </header>
            
            <!-- Supabase ËøûÊé•Áä∂ÊÄÅÊèêÁ§∫ -->
            <div id="supabaseStatus" style="margin: 10px 20px; padding: 10px; border-radius: 5px; display: none;"></div>
            
            <main class="main-content">
                <div class="form-card">
                    <div class="card-header">
                        <h2 class="form-title">„ÅÇ„Å™„Åü„ÅÆÂá∫Âã§„Éá„Éº„Çø</h2>
                        <p class="form-subtitle">„Åì„Åì„Åß„ÅØ„ÄÅ„ÅÇ„Å™„Åü„ÅÆÂá∫Âã§ÊÉÖÂ†±„ÇíÁ¢∫Ë™ç„Åß„Åç„Åæ„Åô</p>
                    </div>
                    
                    <div class="info-section">
                        <div class="info-card">
                            <h3 class="info-title">ÂÄã‰∫∫ÊÉÖÂ†±</h3>
                            <div class="info-item">
                                <span class="info-label">Ê∞èÂêç:</span>
                                <span class="info-value" id="userName"></span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="info-section">
                        <div class="info-card">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                                <h3 class="info-title">Âá∫Âã§Ë®òÈå≤</h3>
                                <button id="exportData" class="btn-export">
                                    <span class="icon">üíæ</span>
                                    „Éá„Éº„Çø„Ç®„ÇØ„Çπ„Éù„Éº„Éà
                                </button>
                            </div>
                            <div class="table-container">
                                <table id="attendanceTable" class="excel-style-table">
                                    <thead>
                                        <tr>
                                            <th>Êó•‰ªò</th>
                                            <th>ÁèæÂ†¥Âêç</th>
                                            <th>„ÉÅ„Éº„É†</th>
                                            <th>ÈßêËªäÊñôÈáë</th>
                                            <th>È´òÈÄüÊñôÈáë</th>
                                            <th>ÂêàË®à</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        <!-- Âá∫Âã§„Éá„Éº„Çø„Åå„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Åæ„Åô -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>
    
    <script type="module">
        // ÂØºÂÖ• Supabase ÂÆ¢Êà∑Á´Ø
        import { supabase } from './js/supabaseClient.js';
        
        // È°µÈù¢Âä†ËΩΩÊó∂ÊµãËØï Supabase ËøûÊé•
        document.addEventListener('DOMContentLoaded', async function() {
            const statusDiv = document.getElementById('supabaseStatus');
            
            try {
                // ÊµãËØïËøûÊé• - Â∞ùËØïËé∑Âèñ‰∏Ä‰∏™ÁÆÄÂçïÁöÑÊü•ËØ¢
                const { data, error } = await supabase
                    .from('attendance_records')
                    .select('id')
                    .limit(1);
                
                if (error) {
                    throw error;
                }
                
                // ÊòæÁ§∫ÊàêÂäüËøûÊé•Ê∂àÊÅØ
                statusDiv.style.display = 'block';
                statusDiv.style.backgroundColor = '#d4edda';
                statusDiv.style.color = '#155724';
                statusDiv.style.border = '1px solid #c3e6cb';
                statusDiv.innerHTML = '‚úÖ ÊàêÂäüËøûÊé•‰∫ëÁ´ØÊï∞ÊçÆÂ∫ì (Supabase)';
                
            } catch (error) {
                // ËøûÊé•Â§±Ë¥•Êó∂‰∏çÊòæÁ§∫ÈîôËØØÔºåÈÅøÂÖçÂΩ±ÂìçÁî®Êà∑‰ΩìÈ™å
                console.log('Supabase ËøûÊé•„ÉÜ„Çπ„ÉàÂ§±Ë¥•:', error.message);
                statusDiv.style.display = 'none';
            }
            
            // ÂàùÂßãÂåñÂéüÊúâÁöÑÁî®Êà∑Êï∞ÊçÆÂäüËÉΩ
            initializeUserData();
        });
        
        // ÂàùÂßãÂåñÁî®Êà∑„Éá„Éº„ÇøÊ©üËÉΩ„ÅÆÂáΩÊï∞
        function initializeUserData() {
            // „Éá„Éº„ÇøÂ≠òÂÇ®„Ç≠„Éº
            const STORAGE_KEY = 'tky_attendance_system';
            const ATTENDANCE_KEY = 'attendance';

            // „Éá„Éº„ÇøÂèñÂæóÈñ¢Êï∞
            function getData(key) {
                const data = JSON.parse(localStorage.getItem(STORAGE_KEY)) || {};
                return key ? data[key] : data;
            }

            // „Éö„Éº„Ç∏Ë™≠„ÅøËæº„ÅøÊôÇ
            // „É≠„Ç∞„Ç§„É≥Áä∂ÊÖã„Çí„ÉÅ„Çß„ÉÉ„ÇØ
            let currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
            if (!currentUser) {
                // Â¶ÇÊûúsessionStorage‰∏≠Ê≤°ÊúâÔºåÂ∞ùËØï‰ªélocalStorageËé∑ÂèñÔºàÂêëÂêéÂÖºÂÆπÔºâ
                currentUser = JSON.parse(localStorage.getItem('currentUser'));
                if (currentUser) {
                    // Â¶ÇÊûúÂú®localStorage‰∏≠ÊâæÂà∞ÔºåÂ∞ÜÂÖ∂ÁßªÂä®Âà∞sessionStorage
                    sessionStorage.setItem('currentUser', JSON.stringify(currentUser));
                    localStorage.removeItem('currentUser');
                }
            }
            
            if (!currentUser) {
                window.location.href = 'index.html';
                return;
            }
            
            // „É¶„Éº„Ç∂„ÉºÊÉÖÂ†±„ÇíË°®Á§∫
            document.getElementById('userName').textContent = currentUser.name;
            
            // Âá∫Âã§„Éá„Éº„Çø„ÇíË°®Á§∫
            renderAttendanceData(currentUser.name);
            
            // Âá∫Âã§„Éá„Éº„Çø„ÇíË°®Á§∫
            function renderAttendanceData(userName) {
                const attendanceData = getData(ATTENDANCE_KEY) || [];
                const userAttendance = attendanceData.filter(record => record.name === userName);
                
                const tbody = document.querySelector('#attendanceTable tbody');
                tbody.innerHTML = '';
                
                let totalParkingFee = 0;
                let totalHighwayFee = 0;
                
                userAttendance.forEach(record => {
                    const row = document.createElement('tr');
                    const total = record.parkingFee + record.highwayFee;
                    totalParkingFee += record.parkingFee;
                    totalHighwayFee += record.highwayFee;
                    
                    row.innerHTML = `
                        <td>${record.date}</td>
                        <td>${record.site}</td>
                        <td>${record.team}</td>
                        <td>${record.parkingFee.toLocaleString()} ÂÜÜ</td>
                        <td>${record.highwayFee.toLocaleString()} ÂÜÜ</td>
                        <td>${total.toLocaleString()} ÂÜÜ</td>
                    `;
                    tbody.appendChild(row);
                });
                
                // ÂêàË®àË°å„ÇíËøΩÂä†
                if (userAttendance.length > 0) {
                    const totalRow = document.createElement('tr');
                    totalRow.innerHTML = `
                        <td colspan="3"><strong>ÂêàË®à</strong></td>
                        <td><strong>${totalParkingFee.toLocaleString()} ÂÜÜ</strong></td>
                        <td><strong>${totalHighwayFee.toLocaleString()} ÂÜÜ</strong></td>
                        <td><strong>${(totalParkingFee + totalHighwayFee).toLocaleString()} ÂÜÜ</strong></td>
                    `;
                    tbody.appendChild(totalRow);
                } else {
                    const noDataRow = document.createElement('tr');
                    noDataRow.innerHTML = `<td colspan="6">Âá∫Âã§„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì</td>`;
                    tbody.appendChild(noDataRow);
                }
            }
            
            // „Éá„Éº„Çø„Ç®„ÇØ„Çπ„Éù„Éº„Éà
            document.getElementById('exportData').addEventListener('click', function() {
                const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
                if (!currentUser) {
                    alert('„É¶„Éº„Ç∂„ÉºÊÉÖÂ†±„ÅåË¶ã„Å§„Åã„Çä„Åæ„Åõ„Çì');
                    return;
                }
                
                const attendanceData = getData(ATTENDANCE_KEY) || [];
                const userAttendance = attendanceData.filter(record => record.name === currentUser.name);
                
                if (userAttendance.length === 0) {
                    alert('„Ç®„ÇØ„Çπ„Éù„Éº„Éà„Åô„Çã„Éá„Éº„Çø„Åå„ÅÇ„Çä„Åæ„Åõ„Çì');
                    return;
                }
                
                // CSV„Éá„Éº„Çø„ÇíÁîüÊàê
                let csv = 'Êó•‰ªò,ÁèæÂ†¥Âêç,„ÉÅ„Éº„É†,ÈßêËªäÊñôÈáë,È´òÈÄüÊñôÈáë,ÂêàË®à\n';
                userAttendance.forEach(record => {
                    const total = record.parkingFee + record.highwayFee;
                    csv += `${record.date},${record.site},${record.team},${record.parkingFee},${record.highwayFee},${total}\n`;
                });
                
                // „Éï„Ç°„Ç§„É´Âêç„ÇíÁîüÊàê
                const now = new Date();
                const timestamp = `${now.getFullYear()}${(now.getMonth()+1).toString().padStart(2, '0')}${now.getDate().toString().padStart(2, '0')}_${now.getHours().toString().padStart(2, '0')}`;
                const filename = `Âá∫Âã§„Éá„Éº„Çø_${currentUser.name}_${timestamp}.csv`;
                
                // „ÉÄ„Ç¶„É≥„É≠„Éº„Éâ
                const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = filename;
                link.click();
            });
            
            // „É≠„Ç∞„Ç¢„Ç¶„ÉàÂá¶ÁêÜ
            document.getElementById('logout').addEventListener('click', function() {
                if (confirm('Êú¨ÂΩì„Å´„É≠„Ç∞„Ç¢„Ç¶„Éà„Åó„Åæ„Åô„ÅãÔºü')) {
                    sessionStorage.removeItem('currentUser');
                    window.location.href = 'index.html';
                }
            });
        }
    </script>
</body>
</html>