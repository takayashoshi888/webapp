    <script type="module">
        // 导入 Supabase 客户端
        import { supabase } from './js/supabaseClient.js';
        
        // 页面加载时测试 Supabase 连接
        document.addEventListener('DOMContentLoaded', async function() {
            const statusDiv = document.getElementById('supabaseStatus');
            
            try {
                // 测试连接 - 尝试获取一个简单的查询
                const { data, error } = await supabase
                    .from('attendance_records')
                    .select('id')
                    .limit(1);
                
                if (error) {
                    throw error;
                }
                
                // 显示成功连接消息
                statusDiv.style.display = 'block';
                statusDiv.style.backgroundColor = '#d4edda';
                statusDiv.style.color = '#155724';
                statusDiv.style.border = '1px solid #c3e6cb';
                statusDiv.innerHTML = '✅ 成功连接云端数据库 (Supabase)';
                
            } catch (error) {
                // 连接失败时不显示错误，避免影响用户体验
                console.log('Supabase 连接テスト失败:', error.message);
                statusDiv.style.display = 'none';
            }
            
            // 初始化原有的用户数据功能
            initializeUserData();
        });
        
        // 初始化用户データ機能の函数
        function initializeUserData() {
            // ページ読み込み時
            // ログイン状態をチェック
            let currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
            if (!currentUser) {
                // 如果sessionStorage中没有，尝试从localStorage获取（向后兼容）
                currentUser = JSON.parse(localStorage.getItem('currentUser'));
                if (currentUser) {
                    // 如果在localStorage中找到，将其移动到sessionStorage
                    sessionStorage.setItem('currentUser', JSON.stringify(currentUser));
                    localStorage.removeItem('currentUser');
                }
            }
            
            if (!currentUser) {
                window.location.href = 'index.html';
                return;
            }
            
            // ユーザー情報を表示
            document.getElementById('userName').textContent = currentUser.name;
            
            // 出勤データを表示
            renderAttendanceData(currentUser.name);
            
            // 出勤データを表示
            async function renderAttendanceData(userName) {
                try {
                    // 从Supabase获取用户的出勤数据
                    const { data: attendanceData, error } = await supabase
                        .from('attendance_details')
                        .select('*')
                        .eq('member_name', userName);
                    
                    if (error) {
                        throw error;
                    }
                    
                    const tbody = document.querySelector('#attendanceTable tbody');
                    tbody.innerHTML = '';
                    
                    let totalParkingFee = 0;
                    let totalHighwayFee = 0;
                    
                    attendanceData.forEach(record => {
                        const row = document.createElement('tr');
                        const parkingFee = record.parking_fee || 0;
                        const highwayFee = record.highway_fee || 0;
                        const total = parkingFee + highwayFee;
                        totalParkingFee += parkingFee;
                        totalHighwayFee += highwayFee;
                        
                        row.innerHTML = `
                            <td>${record.date}</td>
                            <td>${record.site_name}</td>
                            <td>${record.team_name}</td>
                            <td>${parkingFee.toLocaleString()} 円</td>
                            <td>${highwayFee.toLocaleString()} 円</td>
                            <td>${total.toLocaleString()} 円</td>
                        `;
                        tbody.appendChild(row);
                    });
                    
                    // 合計行を追加
                    if (attendanceData.length > 0) {
                        const totalRow = document.createElement('tr');
                        totalRow.innerHTML = `
                            <td colspan="3"><strong>合計</strong></td>
                            <td><strong>${totalParkingFee.toLocaleString()} 円</strong></td>
                            <td><strong>${totalHighwayFee.toLocaleString()} 円</strong></td>
                            <td><strong>${(totalParkingFee + totalHighwayFee).toLocaleString()} 円</strong></td>
                        `;
                        tbody.appendChild(totalRow);
                    } else {
                        const noDataRow = document.createElement('tr');
                        noDataRow.innerHTML = `<td colspan="6">出勤データがありません</td>`;
                        tbody.appendChild(noDataRow);
                    }
                } catch (error) {
                    console.error('获取出勤数据失败:', error);
                    const tbody = document.querySelector('#attendanceTable tbody');
                    tbody.innerHTML = `<tr><td colspan="6">データ取得中にエラーが発生しました</td></tr>`;
                }
            }
            
            // データエクスポート
            document.getElementById('exportData').addEventListener('click', async function() {
                const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
                if (!currentUser) {
                    alert('ユーザー情報が見つかりません');
                    return;
                }
                
                try {
                    // 从Supabase获取用户的出勤数据
                    const { data: attendanceData, error } = await supabase
                        .from('attendance_details')
                        .select('*')
                        .eq('member_name', currentUser.name);
                    
                    if (error) {
                        throw error;
                    }
                    
                    if (attendanceData.length === 0) {
                        alert('エクスポートするデータがありません');
                        return;
                    }
                    
                    // CSVデータを生成
                    let csv = '日付,現場名,チーム,駐車料金,高速料金,合計\n';
                    attendanceData.forEach(record => {
                        const parkingFee = record.parking_fee || 0;
                        const highwayFee = record.highway_fee || 0;
                        const total = parkingFee + highwayFee;
                        csv += `${record.date},${record.site_name},${record.team_name},${parkingFee},${highwayFee},${total}\n`;
                    });
                    
                    // ファイル名を生成
                    const now = new Date();
                    const timestamp = `${now.getFullYear()}${(now.getMonth()+1).toString().padStart(2, '0')}${now.getDate().toString().padStart(2, '0')}_${now.getHours().toString().padStart(2, '0')}`;
                    const filename = `出勤データ_${currentUser.name}_${timestamp}.csv`;
                    
                    // ダウンロード
                    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement('a');
                    link.href = URL.createObjectURL(blob);
                    link.download = filename;
                    link.click();
                } catch (error) {
                    console.error('数据导出失败:', error);
                    alert('データエクスポート中にエラーが発生しました');
                }
            });
            
            // ログアウト処理
            document.getElementById('logout').addEventListener('click', function() {
                if (confirm('本当にログアウトしますか？')) {
                    sessionStorage.removeItem('currentUser');
                    window.location.href = 'index.html';
                }
            });
        }
    </script>
</body>
</html>