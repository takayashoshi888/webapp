<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TKY株式会社 - ユーザー登録</title>
    <link rel="icon" href="http://workbank.page.gd/favicon.ico" type="image/x-icon">
    <link rel="stylesheet" href="style.css">
</head>
<body class="login-container">
    <div class="login-card">
        <div class="login-header">
            <h1>TKY株式会社</h1>
            <p>ユーザー登録</p>
        </div>
        
        <!-- Supabase 连接状态提示 -->
        <div id="supabaseStatus" style="margin: 10px; padding: 10px; border-radius: 5px; display: none;"></div>
        
        <form class="login-form" id="registerForm">
            <div class="error-message" id="errorMessage">
                入力内容にエラーがあります
            </div>
            
            <div class="form-group">
                <label for="username">ユーザー名</label>
                <input type="text" id="username" name="username" placeholder="ユーザー名を入力" required>
            </div>
            
            <div class="form-group">
                <label for="password">パスワード</label>
                <input type="password" id="password" name="password" placeholder="パスワードを入力" required>
                <small>※半角英数字8文字以上</small>
            </div>
            
            <div class="form-group">
                <label for="confirmPassword">パスワード確認</label>
                <input type="password" id="confirmPassword" name="confirmPassword" placeholder="パスワードを再入力" required>
            </div>
            
            <div class="form-group">
                <label for="name">氏名</label>
                <input type="text" id="name" name="name" placeholder="氏名を入力" required>
            </div>
            
            <div class="form-group">
                <label for="team">チーム</label>
                <select id="team" name="team" required>
                    <option value="">チームを選択してください</option>
                    <option value="チームA">チームA</option>
                    <option value="チームB">チームB</option>
                    <option value="チームC">チームC</option>
                </select>
            </div>
            
            <button type="submit" class="login-btn">ユーザー登録</button>
        </form>
        
        <div class="back-to-main">
            <a href="user-login.html">← ログインページに戻る</a>
        </div>
    </div>

    <!-- 加载 Supabase CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        // Supabase 配置
        const supabaseUrl = 'https://xhqvbirifrdlmlnrwayp.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InhocXZiaXJpZnJkbG1sbnJ3YXlwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjA1MTYzNzQsImV4cCI6MjA3NjA5MjM3NH0.CFLPI0sTrO5CYezI2BZRPyaLFS_A7NdxBbZ08qpTlVc';
        const supabase = window.supabase.createClient(supabaseUrl, supabaseKey);

        // 数据存储键
        const STORAGE_KEY = 'tky_attendance_system';
        const MEMBERS_KEY = 'members';
        const TEAMS_KEY = 'teams';

        // 初始数据
        const initialData = {
            [MEMBERS_KEY]: [
                { id: 1, name: '山田太郎', username: 'yamada', password: 'password123', team: 'チームA' },
                { id: 2, name: '佐藤花子', username: 'sato', password: 'password123', team: 'チームB' }
            ],
            [TEAMS_KEY]: ['チームA', 'チームB', 'チームC' ]
        };

        // 页面加载时测试 Supabase 连接
        document.addEventListener('DOMContentLoaded', async function() {
            const statusDiv = document.getElementById('supabaseStatus');
            
            try {
                // 测试连接 - 尝试获取一个简单的查询
                const { data, error } = await supabase
                    .from('members')
                    .select('id')
                    .limit(1);
                
                if (error) {
                    throw error;
                }
                
                // 显示成功连接消息
                statusDiv.style.display = 'block';
                statusDiv.style.backgroundColor = '#d4edda';
                statusDiv.style.color = '#155724';
                statusDiv.style.border = '1px solid #c3e6cb';
                statusDiv.innerHTML = '✅ 成功连接云端数据库 (Supabase)';
                
            } catch (error) {
                // 连接失败时不显示错误，避免影响用户体验
                console.log('Supabase 连接测试失败:', error.message);
                statusDiv.style.display = 'none';
            }
            
            // 初始化页面功能
            initializeUserRegistration();
        });

        // 获取团队ID的辅助函数
        async function getTeamId(teamName) {
            try {
                const { data, error } = await supabase
                    .from('teams')
                    .select('id')
                    .eq('name', teamName)
                    .single();
                
                if (!error && data) {
                    return data.id;
                }
                return null;
            } catch (error) {
                console.error('获取团队ID失败:', error);
                return null;
            }
        }

        // 初始化用户注册功能
        function initializeUserRegistration() {
            // 用户注册处理
            document.getElementById('registerForm').addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const username = document.getElementById('username').value;
                const password = document.getElementById('password').value;
                const confirmPassword = document.getElementById('confirmPassword').value;
                const name = document.getElementById('name').value;
                const team = document.getElementById('team').value;
                const errorMessage = document.getElementById('errorMessage');
                
                // 隐藏错误消息
                errorMessage.classList.remove('show');
                
                // 密码确认
                if (password !== confirmPassword) {
                    showError('パスワードが一致しません');
                    return;
                }
                
                // 密码长度检查
                if (password.length < 8) {
                    showError('パスワードは8文字以上である必要があります');
                    return;
                }
                
                // 用户名不能为空
                if (!username.trim()) {
                    showError('ユーザー名を入力してください');
                    return;
                }
                
                // 姓名不能为空
                if (!name.trim()) {
                    showError('氏名を入力してください');
                    return;
                }
                
                // 团队选择检查
                if (!team) {
                    showError('チームを選択してください');
                    return;
                }
                
                try {
                    // 检查用户名是否已存在（Supabase）
                    const { data: existingUser, error: checkError } = await supabase
                        .from('members')
                        .select('id')
                        .eq('username', username)
                        .single();
                    
                    if (existingUser) {
                        showError('このユーザー名は既に使用されています');
                        return;
                    }
                    
                    // 获取团队ID
                    const teamId = await getTeamId(team);
                    if (!teamId) {
                        showError('チーム情報の取得に失敗しました');
                        return;
                    }
                    
                    // 注册新用户到Supabase
                    const { data: newUser, error: insertError } = await supabase
                        .from('members')
                        .insert({
                            name: name,
                            username: username,
                            password: password,
                            team_id: teamId
                        })
                        .select()
                        .single();
                    
                    if (insertError) {
                        throw new Error(insertError.message);
                    }
                    
                    // 同时更新本地存储以保持一致性
                    let localData = JSON.parse(localStorage.getItem(STORAGE_KEY)) || initialData;
                    
                    // 确保本地数据结构正确
                    if (!localData[MEMBERS_KEY]) localData[MEMBERS_KEY] = [];
                    if (!localData[TEAMS_KEY]) localData[TEAMS_KEY] = ['チームA', 'チームB', 'チームC'];
                    
                    // 生成新的成员ID
                    const members = localData[MEMBERS_KEY];
                    const newId = members.length > 0 ? Math.max(...members.map(m => m.id)) + 1 : 1;
                    
                    // 添加新成员到本地存储
                    members.push({ 
                        id: newId, 
                        name: name, 
                        username: username, 
                        password: password, 
                        team: team 
                    });
                    
                    // 保存到本地存储
                    localStorage.setItem(STORAGE_KEY, JSON.stringify(localData));
                    
                    // 注册成功消息
                    alert('ユーザー登録が完了しました！');
                    
                    // 重定向到登录页面
                    window.location.href = 'user-login.html';
                } catch (error) {
                    console.error('注册错误:', error);
                    showError('登録中にエラーが発生しました: ' + error.message);
                }
            });
        }
        
        // 显示错误消息的辅助函数
        function showError(message) {
            const errorMessage = document.getElementById('errorMessage');
            errorMessage.textContent = message;
            errorMessage.classList.add('show');
            
            // 3秒后隐藏错误消息
            setTimeout(() => {
                errorMessage.classList.remove('show');
            }, 3000);
        }
    </script>
</body>
</html>