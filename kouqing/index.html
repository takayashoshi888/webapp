<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>每日出工记录系统</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #34495e;
            --accent-color: #e67e22;
            --text-color: #333;
            --input-border-color: #bdc3c7;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f6f9;
            color: var(--text-color);
        }

        .form-container,
        .table-container,
        .stats-container,
        .chart-container {
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            color: var(--secondary-color);
            font-weight: 600;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 0.75rem 1rem;
            border: 1px solid var(--input-border-color);
            border-radius: 8px;
            transition: border-color 0.3s ease;
            color: var(--text-color);
        }

        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: var(--accent-color);
        }

        .btn-primary {
            background-color: var(--accent-color);
            color: white;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s ease, transform 0.3s ease;
        }

        .btn-primary:hover {
            background-color: #d35400;
            transform: scale(1.05);
        }

        .btn-secondary {
            background-color: var(--secondary-color);
            color: white;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .btn-secondary:hover {
            background-color: #2c3e50;
        }

        .btn-danger {
            background-color: #e74c3c;
            color: white;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }

        .btn-danger:hover {
            background-color: #c0392b;
        }

        .notification {
            position: fixed;
            top: 1rem;
            right: 1rem;
            padding: 1rem 1.5rem;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            z-index: 1000;
            display: flex;
            align-items: center;
            transform: translateX(120%);
            transition: transform 0.3s ease;
        }

        .notification.show {
            transform: translateX(0);
        }

        .notification.success {
            background-color: #2ecc71;
            color: white;
        }

        .notification.error {
            background-color: #e74c3c;
            color: white;
        }

        .notification.warning {
            background-color: #f39c12;
            color: white;
        }

        .pagination {
            display: flex;
            justify-content: center;
            margin-top: 1rem;
        }

        .pagination button {
            margin: 0 0.25rem;
            padding: 0.5rem 0.75rem;
            border: 1px solid #ddd;
            background-color: white;
            cursor: pointer;
            border-radius: 4px;
        }

        .pagination button.active {
            background-color: var(--accent-color);
            color: white;
            border-color: var(--accent-color);
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        #loginContainer {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            background-image: url('https://c-ssl.duitang.com/uploads/blog/202207/16/20220716155720_f09d7.jpg'); /* 添加背景图片 */
            background-size: cover; /* 使背景图片覆盖整个容器 */
            background-position: center; /* 背景图片居中 */
        }

        #loginForm {
            background-color: white;
            padding: 2rem;
            border-radius: 12px;
            width: 100%;
            max-width: 400px;
        }

        .modal {
            position: fixed;
            inset: 0;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background-color: white;
            padding: 2rem;
            border-radius: 12px;
            width: 100%;
            max-width: 500px;
        }

        .badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 9999px;
            font-size: 0.75rem;
            font-weight: 600;
            background-color: #e2e8f0;
            color: #4a5568;
        }

        .badge-primary {
            background-color: #bee3f8;
            color: #2b6cb0;
        }

        .badge-success {
            background-color: #c6f6d5;
            color: #2f855a;
        }

        .badge-warning {
            background-color: #feebc8;
            color: #b7791f;
        }

        .badge-danger {
            background-color: #fed7d7;
            color: #c53030;
        }
    </style>
</head>

<body class="container mx-auto p-4 md:p-8">
    <!-- 登录界面 -->
    <div id="loginContainer">
        <form id="loginForm">
            <h2 class="text-2xl font-bold mb-6 text-center">用户登录</h2>
            <div class="form-group">
                <label for="username">用户名</label>
                <input type="text" id="username" required minlength="3" maxlength="20">
            </div>
            <div class="form-group">
                <label for="password">密码</label>
                <input type="password" id="password" required minlength="6" maxlength="30">
            </div>
            <div class="flex justify-between items-center mt-6">
                <button type="button" id="registerBtn" class="btn-secondary">注册</button>
                <button type="submit" class="btn-primary">登录</button>
            </div>
        </form>
    </div>

    <!-- 注册模态框 -->
    <div id="registerModal" class="modal hidden">
        <div class="modal-content">
            <h2 class="text-2xl font-bold mb-6 text-center">用户注册</h2>
            <form id="registerForm">
                <div class="form-group">
                    <label for="regUsername">用户名</label>
                    <input type="text" id="regUsername" required minlength="3" maxlength="20">
                </div>
                <div class="form-group">
                    <label for="regPassword">密码</label>
                    <input type="password" id="regPassword" required minlength="6" maxlength="30">
                </div>
                <div class="form-group">
                    <label for="regConfirmPassword">确认密码</label>
                    <input type="password" id="regConfirmPassword" required minlength="6" maxlength="30">
                </div>
                <div class="flex justify-between items-center mt-6">
                    <button type="button" id="cancelRegisterBtn" class="btn-secondary">取消</button>
                    <button type="submit" class="btn-primary">注册</button>
                </div>
            </form>
        </div>
    </div>

    <!-- 数据备份/恢复模态框 -->
    <div id="backupModal" class="modal hidden">
        <div class="modal-content">
            <h2 class="text-2xl font-bold mb-6 text-center">数据备份与恢复</h2>
            <div class="space-y-4">
                <div>
                    <h3 class="text-lg font-semibold mb-2">备份数据</h3>
                    <p class="text-gray-600 mb-4">将当前数据导出为JSON文件保存到本地</p>
                    <button id="exportBackupBtn" class="btn-primary w-full">导出备份</button>
                </div>
                <div>
                    <h3 class="text-lg font-semibold mb-2">恢复数据</h3>
                    <p class="text-gray-600 mb-4">从之前导出的备份文件恢复数据</p>
                    <div class="flex items-center space-x-2">
                        <input type="file" id="backupFile" accept=".json" class="hidden">
                        <button id="chooseBackupBtn" class="btn-secondary flex-1">选择备份文件</button>
                        <button id="importBackupBtn" class="btn-primary flex-1" disabled>导入备份</button>
                    </div>
                    <p id="backupFileName" class="text-sm text-gray-500 mt-2 hidden"></p>
                </div>
            </div>
            <div class="flex justify-end mt-6">
                <button id="closeBackupModalBtn" class="btn-secondary">关闭</button>
            </div>
        </div>
    </div>

    <!-- 批量操作模态框 -->
    <div id="batchModal" class="modal hidden">
        <div class="modal-content">
            <h2 class="text-2xl font-bold mb-6 text-center">批量操作</h2>
            <div class="space-y-4">
                <div>
                    <h3 class="text-lg font-semibold mb-2">批量删除</h3>
                    <p class="text-gray-600 mb-4">删除选中的记录（<span id="selectedCount">0</span>条）</p>
                    <button id="confirmBatchDeleteBtn" class="btn-danger w-full">确认删除</button>
                </div>
                <div>
                    <h3 class="text-lg font-semibold mb-2">批量编辑</h3>
                    <p class="text-gray-600 mb-4">编辑选中的记录（<span id="selectedEditCount">0</span>条）</p>
                    <div class="form-group">
                        <label for="batchSiteName">现场名称</label>
                        <input type="text" id="batchSiteName" placeholder="留空则不修改">
                    </div>
                    <button id="confirmBatchEditBtn" class="btn-primary w-full">确认编辑</button>
                </div>
            </div>
            <div class="flex justify-end mt-6">
                <button id="closeBatchModalBtn" class="btn-secondary">关闭</button>
            </div>
        </div>
    </div>

    <!-- 主应用界面 -->
    <div id="appContainer" class="hidden">
        <div class="flex justify-between items-center mb-6">
            <h1 class="text-3xl font-bold">每日出工记录系统</h1>
            <div class="flex items-center space-x-4">
                <span id="currentUser" class="font-semibold"></span>
                <div class="dropdown relative">
                    <button id="userMenuBtn" class="btn-secondary text-sm flex items-center">
                        <span>操作</span>
                        <i class="fas fa-chevron-down ml-2 text-xs"></i>
                    </button>
                    <div id="userMenu" class="dropdown-menu absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg py-1 z-50 hidden">
                        <button id="backupBtn" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">数据备份/恢复</button>
                        <button id="logoutBtn" class="block w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100">退出登录</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <!-- 数据采集 -->
            <div class="form-container lg:col-span-1">
                <h2 class="text-xl font-bold mb-4">数据采集</h2>
                <form id="recordForm">
                    <div class="form-group">
                        <label for="date">日期</label>
                        <input type="date" id="date" required>
                    </div>
                    <div class="form-group">
                        <label for="name">姓名</label>
                        <input type="text" id="name" required minlength="2" maxlength="20">
                    </div>
                    <div class="form-group">
                        <label for="numberOfPeople">人数</label>
                        <input type="number" id="numberOfPeople" min="1" max="100" required>
                    </div>
                    <div class="form-group">
                        <label for="siteName">现场名称</label>
                        <input type="text" id="siteName" required minlength="2" maxlength="50">
                    </div>
                    <div class="form-group">
                        <label for="highwayFee">高速费</label>
                        <input type="number" id="highwayFee" min="0" step="0.01" required>
                    </div>
                    <div class="form-group">
                        <label for="parkingFee">停车费</label>
                        <input type="number" id="parkingFee" min="0" step="0.01" required>
                    </div>
                    <button type="submit" class="btn-primary w-full">提交记录</button>
                </form>
            </div>

            <!-- 记录列表和统计 -->
            <div class="lg:col-span-2 space-y-6">
                <div class="table-container">
                    <div class="flex justify-between items-center mb-4">
                        <h2 class="text-xl font-bold">记录列表</h2>
                        <div class="flex space-x-2">
                            <button id="batchOperationBtn" class="btn-secondary" disabled>批量操作</button>
                            <input type="text" id="searchInput" placeholder="搜索..." class="border rounded px-3 py-1">
                            <select id="filterSelect" class="border rounded px-3 py-1">
                                <option value="">全部</option>
                                <option value="date">按日期</option>
                                <option value="name">按姓名</option>
                                <option value="site">按现场</option>
                            </select>
                            <select id="sortSelect" class="border rounded px-3 py-1">
                                <option value="date-desc">最新在前</option>
                                <option value="date-asc">最早在前</option>
                                <option value="fee-desc">费用高在前</option>
                                <option value="fee-asc">费用低在前</option>
                            </select>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table id="recordTable" class="w-full">
                            <thead>
                                <tr class="bg-gray-100">
                                    <th class="p-3 text-left"><input type="checkbox" id="selectAll"></th>
                                    <th class="p-3 text-left">日期</th>
                                    <th class="p-3 text-left">姓名</th>
                                    <th class="p-3 text-left">人数</th>
                                    <th class="p-3 text-left">现场名称</th>
                                    <th class="p-3 text-left">高速费</th>
                                    <th class="p-3 text-left">停车费</th>
                                    <th class="p-3 text-left">总费用</th>
                                    <th class="p-3 text-left">操作</th>
                                </tr>
                            </thead>
                            <tbody></tbody>
                        </table>
                    </div>
                    <div class="pagination mt-4">
                        <button id="prevPage" disabled>上一页</button>
                        <span id="pageInfo" class="mx-4"></span>
                        <button id="nextPage" disabled>下一页</button>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="stats-container">
                        <h2 class="text-xl font-bold mb-4">统计信息</h2>
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <p class="text-gray-600">总天数</p>
                                <p class="text-2xl font-bold" id="totalDays">0</p>
                            </div>
                            <div>
                                <p class="text-gray-600">总人数</p>
                                <p class="text-2xl font-bold" id="totalPeople">0</p>
                            </div>
                            <div>
                                <p class="text-gray-600">总费用</p>
                                <p class="text-2xl font-bold" id="totalFee">0</p>
                            </div>
                            <div>
                                <p class="text-gray-600">平均费用</p>
                                <p class="text-2xl font-bold" id="avgFee">0</p>
                            </div>
                        </div>
                        <div class="mt-4">
                            <h3 class="text-lg font-semibold mb-2">按人员统计</h3>
                            <div id="peopleStats" class="space-y-2"></div>
                        </div>
                    </div>

                    <div class="chart-container">
                        <h2 class="text-xl font-bold mb-4">费用分布</h2>
                        <div class="flex justify-center mb-4">
                            <div class="inline-flex rounded-md shadow-sm" role="group">
                                <button type="button" data-chart-type="bar" class="chart-type-btn px-4 py-2 text-sm font-medium text-gray-900 bg-white border border-gray-200 rounded-l-lg hover:bg-gray-100 hover:text-blue-700 focus:z-10 focus:ring-2 focus:ring-blue-700 focus:text-blue-700">
                                    柱状图
                                </button>
                                <button type="button" data-chart-type="line" class="chart-type-btn px-4 py-2 text-sm font-medium text-gray-900 bg-white border-t border-b border-gray-200 hover:bg-gray-100 hover:text-blue-700 focus:z-10 focus:ring-2 focus:ring-blue-700 focus:text-blue-700">
                                    折线图
                                </button>
                                <button type="button" data-chart-type="pie" class="chart-type-btn px-4 py-2 text-sm font-medium text-gray-900 bg-white border border-gray-200 rounded-r-md hover:bg-gray-100 hover:text-blue-700 focus:z-10 focus:ring-2 focus:ring-blue-700 focus:text-blue-700">
                                    饼图
                                </button>
                            </div>
                        </div>
                        <canvas id="feeChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <div class="flex justify-end space-x-4 mt-6">
            <button id="exportCSV" class="btn-secondary">导出 CSV</button>
            <button id="exportExcel" class="btn-secondary">导出 Excel</button>
            <button id="exportPDF" class="btn-primary">导出 PDF</button>
        </div>
    </div>

    <!-- 通知组件 -->
    <div id="notification" class="notification">
        <span id="notificationMessage"></span>
        <button class="ml-4" onclick="this.parentElement.classList.remove('show')">
            <i class="fas fa-times"></i>
        </button>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdn.sheetjs.com/xlsx-0.19.3/package/dist/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>

    <script>
        // 全局变量
        let records = [];
        let currentUser = null;
        let currentPage = 1;
        const recordsPerPage = 10;
        let feeChart = null;
        let selectedRecords = new Set();
        let backupFile = null;

        // DOM元素
        const loginContainer = document.getElementById('loginContainer');
        const appContainer = document.getElementById('appContainer');
        const loginForm = document.getElementById('loginForm');
        const registerBtn = document.getElementById('registerBtn');
        const registerModal = document.getElementById('registerModal');
        const registerForm = document.getElementById('registerForm');
        const cancelRegisterBtn = document.getElementById('cancelRegisterBtn');
        const logoutBtn = document.getElementById('logoutBtn');
        const currentUserSpan = document.getElementById('currentUser');
        const userMenuBtn = document.getElementById('userMenuBtn');
        const userMenu = document.getElementById('userMenu');
        const backupBtn = document.getElementById('backupBtn');
        const backupModal = document.getElementById('backupModal');
        const exportBackupBtn = document.getElementById('exportBackupBtn');
        const chooseBackupBtn = document.getElementById('chooseBackupBtn');
        const importBackupBtn = document.getElementById('importBackupBtn');
        const backupFileInput = document.getElementById('backupFile');
        const backupFileName = document.getElementById('backupFileName');
        const closeBackupModalBtn = document.getElementById('closeBackupModalBtn');
        const batchOperationBtn = document.getElementById('batchOperationBtn');
        const batchModal = document.getElementById('batchModal');
        const selectedCountSpan = document.getElementById('selectedCount');
        const selectedEditCountSpan = document.getElementById('selectedEditCount');
        const confirmBatchDeleteBtn = document.getElementById('confirmBatchDeleteBtn');
        const confirmBatchEditBtn = document.getElementById('confirmBatchEditBtn');
        const batchSiteNameInput = document.getElementById('batchSiteName');
        const closeBatchModalBtn = document.getElementById('closeBatchModalBtn');
        const recordForm = document.getElementById('recordForm');
        const recordTable = document.getElementById('recordTable').getElementsByTagName('tbody')[0];
        const selectAllCheckbox = document.getElementById('selectAll');
        const searchInput = document.getElementById('searchInput');
        const filterSelect = document.getElementById('filterSelect');
        const sortSelect = document.getElementById('sortSelect');
        const prevPageBtn = document.getElementById('prevPage');
        const nextPageBtn = document.getElementById('nextPage');
        const pageInfoSpan = document.getElementById('pageInfo');
        const totalDaysElement = document.getElementById('totalDays');
        const totalPeopleElement = document.getElementById('totalPeople');
        const totalFeeElement = document.getElementById('totalFee');
        const avgFeeElement = document.getElementById('avgFee');
        const peopleStatsElement = document.getElementById('peopleStats');
        const exportCSVButton = document.getElementById('exportCSV');
        const exportExcelButton = document.getElementById('exportExcel');
        const exportPDFButton = document.getElementById('exportPDF');
        const notification = document.getElementById('notification');
        const notificationMessage = document.getElementById('notificationMessage');
        const chartTypeButtons = document.querySelectorAll('.chart-type-btn');

        // 初始化
        document.addEventListener('DOMContentLoaded', function() {
            // 设置默认日期为今天
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('date').value = today;
            
            // 加载用户数据
            checkAuthState();
            
            // 初始化图表
            initChart();
            
            // 设置提醒
            setReminder();
            
            // 初始化事件监听
            initEventListeners();
        });

        // 初始化事件监听
        function initEventListeners() {
            // 用户菜单
            userMenuBtn.addEventListener('click', toggleUserMenu);
            document.addEventListener('click', closeUserMenuOnClickOutside);
            
            // 批量操作
            selectAllCheckbox.addEventListener('change', toggleSelectAll);
            batchOperationBtn.addEventListener('click', openBatchModal);
            confirmBatchDeleteBtn.addEventListener('click', confirmBatchDelete);
            confirmBatchEditBtn.addEventListener('click', confirmBatchEdit);
            closeBatchModalBtn.addEventListener('click', closeBatchModal);
            
            // 数据备份/恢复
            backupBtn.addEventListener('click', openBackupModal);
            exportBackupBtn.addEventListener('click', exportBackup);
            chooseBackupBtn.addEventListener('click', () => backupFileInput.click());
            backupFileInput.addEventListener('change', handleBackupFileSelect);
            importBackupBtn.addEventListener('click', importBackup);
            closeBackupModalBtn.addEventListener('click', closeBackupModal);
            
            // 图表类型切换
            chartTypeButtons.forEach(btn => {
                btn.addEventListener('click', () => changeChartType(btn.dataset.chartType));
            });
        }

        // 用户认证相关功能
        function checkAuthState() {
            const savedUser = localStorage.getItem('currentUser');
            if (savedUser) {
                try {
                    currentUser = JSON.parse(savedUser);
                    currentUserSpan.textContent = currentUser.username;
                    loginContainer.style.display = 'none';
                    appContainer.classList.remove('hidden');
                    loadRecords();
                } catch (error) {
                    showNotification('用户数据解析失败', 'error');
                    logout();
                }
            } else {
                loginContainer.style.display = 'flex';
                appContainer.classList.add('hidden');
            }
        }

        function hashPassword(password) {
            return CryptoJS.SHA256(password).toString();
        }

        function validatePassword(password) {
            // 密码至少6位，包含字母和数字
            const regex = /^(?=.*[A-Za-z])(?=.*\d)[A-Za-z\d]{6,}$/;
            return regex.test(password);
        }

        loginForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const username = document.getElementById('username').value.trim();
            const password = document.getElementById('password').value.trim();
            
            if (!username || !password) {
                showNotification('请输入用户名和密码', 'error');
                return;
            }
            
            // 模拟认证 - 实际应用中应该使用后端API
            const users = JSON.parse(localStorage.getItem('users') || '[]');
            const user = users.find(u => u.username === username && u.password === hashPassword(password));
            
            if (user) {
                currentUser = { username: user.username };
                localStorage.setItem('currentUser', JSON.stringify(currentUser));
                showNotification('登录成功', 'success');
                checkAuthState();
            } else {
                showNotification('用户名或密码错误', 'error');
            }
        });

        registerBtn.addEventListener('click', function() {
            registerModal.classList.remove('hidden');
        });

        cancelRegisterBtn.addEventListener('click', function(e) {
            e.preventDefault();
            registerModal.classList.add('hidden');
        });

        registerForm.addEventListener('submit', function(e) {
            e.preventDefault();
            const username = document.getElementById('regUsername').value.trim();
            const password = document.getElementById('regPassword').value.trim();
            const confirmPassword = document.getElementById('regConfirmPassword').value.trim();
            
            if (!username || !password || !confirmPassword) {
                showNotification('请填写所有字段', 'error');
                return;
            }
            
            if (password !== confirmPassword) {
                showNotification('两次输入的密码不一致', 'error');
                return;
            }
            
            if (!validatePassword(password)) {
                showNotification('密码至少6位且包含字母和数字', 'error');
                return;
            }
            
            // 检查用户名是否已存在
            const users = JSON.parse(localStorage.getItem('users') || '[]');
            if (users.some(u => u.username === username)) {
                showNotification('用户名已存在', 'error');
                return;
            }
            
            // 保存新用户
            const newUser = {
                username,
                password: hashPassword(password)
            };
            
            users.push(newUser);
            localStorage.setItem('users', JSON.stringify(users));
            
            showNotification('注册成功，请登录', 'success');
            registerModal.classList.add('hidden');
            registerForm.reset();
        });

        function logout() {
            currentUser = null;
            localStorage.removeItem('currentUser');
            showNotification('已退出登录', 'success');
            checkAuthState();
        }

        logoutBtn.addEventListener('click', logout);

        function toggleUserMenu() {
            userMenu.classList.toggle('hidden');
        }

        function closeUserMenuOnClickOutside(e) {
            if (!userMenu.contains(e.target) && !userMenuBtn.contains(e.target)) {
                userMenu.classList.add('hidden');
            }
        }

        // 记录表单提交
        recordForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            // 获取表单数据
            const date = document.getElementById('date').value;
            const name = document.getElementById('name').value.trim();
            const numberOfPeople = parseInt(document.getElementById('numberOfPeople').value);
            const siteName = document.getElementById('siteName').value.trim();
            const highwayFee = parseFloat(document.getElementById('highwayFee').value) || 0;
            const parkingFee = parseFloat(document.getElementById('parkingFee').value) || 0;
            
            // 验证数据
            const validationErrors = validateRecord({
                date, name, numberOfPeople, siteName, highwayFee, parkingFee
            });
            
            if (validationErrors) {
                showNotification(validationErrors.join('<br>'), 'error');
                return;
            }
            
            // 创建记录对象
            const record = {
                id: generateId(),
                date,
                name,
                numberOfPeople,
                siteName,
                highwayFee,
                parkingFee,
                totalFee: highwayFee + parkingFee,
                createdAt: new Date().toISOString()
            };
            
            // 添加到记录数组
            records.push(record);
            
            // 保存并更新UI
            saveRecords();
            updateTable();
            updateStatistics();
            updateChart();
            
            // 重置表单
            recordForm.reset();
            document.getElementById('date').value = new Date().toISOString().split('T')[0];
            
            showNotification('记录已保存', 'success');
        });

        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }

        function validateRecord(record) {
            const errors = [];
            
            if (!record.date) errors.push('请选择日期');
            if (!record.name || record.name.length < 2) errors.push('请输入有效的姓名(至少2个字符)');
            if (isNaN(record.numberOfPeople) || record.numberOfPeople <= 0 || record.numberOfPeople > 100) {
                errors.push('请输入有效的人数(1-100)');
            }
            if (!record.siteName || record.siteName.length < 2) errors.push('请输入有效的现场名称(至少2个字符)');
            if (isNaN(record.highwayFee) || record.highwayFee < 0) errors.push('请输入有效的高速费');
            if (isNaN(record.parkingFee) || record.parkingFee < 0) errors.push('请输入有效的停车费');
            
            return errors.length ? errors : null;
        }

        // 数据存储功能
        function saveRecords() {
            if (currentUser) {
                try {
                    localStorage.setItem(`records_${currentUser.username}`, JSON.stringify(records));
                } catch (error) {
                    showNotification('保存数据失败: ' + error.message, 'error');
                }
            }
        }

        function loadRecords() {
            if (currentUser) {
                try {
                    const savedRecords = localStorage.getItem(`records_${currentUser.username}`);
                    if (savedRecords) {
                        records = JSON.parse(savedRecords);
                        updateTable();
                        updateStatistics();
                        updateChart();
                    }
                } catch (error) {
                    showNotification('加载数据失败: ' + error.message, 'error');
                }
            }
        }

        // 表格更新功能
        function updateTable() {
            recordTable.innerHTML = '';
            selectedRecords.clear();
            updateBatchOperationButton();
            
            // 过滤和排序
            const filteredRecords = filterAndSortRecords();
            
            // 分页计算
            const start = (currentPage - 1) * recordsPerPage;
            const end = start + recordsPerPage;
            const paginatedRecords = filteredRecords.slice(start, end);
            
            // 填充表格
            paginatedRecords.forEach((record, index) => {
                const row = recordTable.insertRow();
                
                // 选择框单元格
                const selectCell = row.insertCell(0);
                const checkbox = document.createElement('input');
                checkbox.type = 'checkbox';
                checkbox.className = 'record-checkbox';
                checkbox.dataset.id = record.id;
                checkbox.addEventListener('change', () => toggleRecordSelection(record.id));
                selectCell.appendChild(checkbox);
                
                // 日期单元格
                const dateCell = row.insertCell(1);
                dateCell.textContent = record.date;
                
                // 姓名单元格
                const nameCell = row.insertCell(2);
                nameCell.textContent = record.name;
                
                // 人数单元格
                const peopleCell = row.insertCell(3);
                peopleCell.textContent = record.numberOfPeople;
                
                // 现场名称单元格
                const siteCell = row.insertCell(4);
                siteCell.textContent = record.siteName;
                
                // 高速费单元格
                const highwayCell = row.insertCell(5);
                highwayCell.textContent = record.highwayFee.toFixed(2);
                
                // 停车费单元格
                const parkingCell = row.insertCell(6);
                parkingCell.textContent = record.parkingFee.toFixed(2);
                
                // 总费用单元格
                const totalCell = row.insertCell(7);
                totalCell.textContent = record.totalFee.toFixed(2);
                
                // 操作单元格
                const actionCell = row.insertCell(8);
                const deleteBtn = document.createElement('button');
                deleteBtn.innerHTML = '<i class="fas fa-trash text-red-500"></i>';
                deleteBtn.className = 'hover:text-red-700';
                deleteBtn.onclick = (e) => {
                    e.stopPropagation();
                    deleteRecord(record.id);
                };
                actionCell.appendChild(deleteBtn);
            });
            
            // 更新分页信息
            updatePagination();
        }

        function filterAndSortRecords() {
            let filteredRecords = [...records];
            const searchTerm = searchInput.value.toLowerCase();
            const filterType = filterSelect.value;
            
            // 搜索过滤
            if (searchTerm) {
                filteredRecords = filteredRecords.filter(record => {
                    return (
                        record.date.includes(searchTerm) ||
                        record.name.toLowerCase().includes(searchTerm) ||
                        record.siteName.toLowerCase().includes(searchTerm) ||
                        record.totalFee.toString().includes(searchTerm)
                    );
                });
            }
            
            // 排序
            const sortOption = sortSelect.value;
            filteredRecords.sort((a, b) => {
                switch (sortOption) {
                    case 'date-asc':
                        return new Date(a.date) - new Date(b.date);
                    case 'date-desc':
                        return new Date(b.date) - new Date(a.date);
                    case 'fee-asc':
                        return a.totalFee - b.totalFee;
                    case 'fee-desc':
                        return b.totalFee - a.totalFee;
                    default:
                        return 0;
                }
            });
            
            return filteredRecords;
        }

        function deleteRecord(id) {
            if (confirm('确定要删除这条记录吗?')) {
                const index = records.findIndex(r => r.id === id);
                if (index !== -1) {
                    records.splice(index, 1);
                    saveRecords();
                    updateTable();
                    updateStatistics();
                    updateChart();
                    showNotification('记录已删除', 'success');
                }
            }
        }

        // 分页功能
        function updatePagination() {
            const filteredRecords = filterAndSortRecords();
            const totalPages = Math.ceil(filteredRecords.length / recordsPerPage) || 1;
            
            prevPageBtn.disabled = currentPage <= 1;
            nextPageBtn.disabled = currentPage >= totalPages;
            
            pageInfoSpan.textContent = `第 ${currentPage} 页 / 共 ${totalPages} 页 (共 ${filteredRecords.length} 条记录)`;
        }

        prevPageBtn.addEventListener('click', function() {
            if (currentPage > 1) {
                currentPage--;
                updateTable();
            }
        });

        nextPageBtn.addEventListener('click', function() {
            const filteredRecords = filterAndSortRecords();
            const totalPages = Math.ceil(filteredRecords.length / recordsPerPage);
            if (currentPage < totalPages) {
                currentPage++;
                updateTable();
            }
        });

        // 搜索和筛选功能
        searchInput.addEventListener('input', function() {
            currentPage = 1;
            updateTable();
        });

        filterSelect.addEventListener('change', function() {
            currentPage = 1;
            updateTable();
        });

        sortSelect.addEventListener('change', function() {
            currentPage = 1;
            updateTable();
        });

        // 批量操作功能
        function toggleSelectAll() {
            const checkboxes = document.querySelectorAll('.record-checkbox');
            checkboxes.forEach(checkbox => {
                checkbox.checked = selectAllCheckbox.checked;
                if (selectAllCheckbox.checked) {
                    selectedRecords.add(checkbox.dataset.id);
                } else {
                    selectedRecords.delete(checkbox.dataset.id);
                }
            });
            updateBatchOperationButton();
        }

        function toggleRecordSelection(id) {
            if (selectedRecords.has(id)) {
                selectedRecords.delete(id);
            } else {
                selectedRecords.add(id);
            }
            updateBatchOperationButton();
        }

        function updateBatchOperationButton() {
            batchOperationBtn.disabled = selectedRecords.size === 0;
            selectAllCheckbox.checked = selectedRecords.size > 0 && 
                                      selectedRecords.size === document.querySelectorAll('.record-checkbox').length;
        }

        function openBatchModal() {
            selectedCountSpan.textContent = selectedRecords.size;
            selectedEditCountSpan.textContent = selectedRecords.size;
            batchModal.classList.remove('hidden');
        }

        function closeBatchModal() {
            batchModal.classList.add('hidden');
            batchSiteNameInput.value = '';
        }

        function confirmBatchDelete() {
            if (selectedRecords.size === 0) {
                showNotification('请先选择要删除的记录', 'warning');
                return;
            }
            
            if (confirm(`确定要删除选中的 ${selectedRecords.size} 条记录吗?`)) {
                records = records.filter(record => !selectedRecords.has(record.id));
                saveRecords();
                updateTable();
                updateStatistics();
                updateChart();
                closeBatchModal();
                showNotification(`已删除 ${selectedRecords.size} 条记录`, 'success');
            }
        }

        function confirmBatchEdit() {
            if (selectedRecords.size === 0) {
                showNotification('请先选择要编辑的记录', 'warning');
                return;
            }
            
            const newSiteName = batchSiteNameInput.value.trim();
            if (!newSiteName) {
                showNotification('请输入新的现场名称', 'error');
                return;
            }
            
            if (confirm(`确定要更新选中的 ${selectedRecords.size} 条记录的现场名称为 "${newSiteName}" 吗?`)) {
                records.forEach(record => {
                    if (selectedRecords.has(record.id)) {
                        record.siteName = newSiteName;
                    }
                });
                
                saveRecords();
                updateTable();
                updateStatistics();
                updateChart();
                closeBatchModal();
                showNotification(`已更新 ${selectedRecords.size} 条记录`, 'success');
            }
        }

        // 统计功能
        function updateStatistics() {
            const totalDays = records.length;
            let totalPeople = 0;
            let totalFee = 0;
            
            // 按人员统计
            const peopleStats = {};
            
            records.forEach(record => {
                totalPeople += record.numberOfPeople;
                totalFee += record.totalFee;
                
                if (!peopleStats[record.name]) {
                    peopleStats[record.name] = {
                        count: 0,
                        fee: 0
                    };
                }
                
                peopleStats[record.name].count += record.numberOfPeople;
                peopleStats[record.name].fee += record.totalFee;
            });
            
            const avgFee = totalDays > 0 ? totalFee / totalDays : 0;
            
            totalDaysElement.textContent = totalDays;
            totalPeopleElement.textContent = totalPeople;
            totalFeeElement.textContent = totalFee.toFixed(2);
            avgFeeElement.textContent = avgFee.toFixed(2);
            
            // 更新人员统计
            updatePeopleStats(peopleStats);
        }

        function updatePeopleStats(peopleStats) {
            peopleStatsElement.innerHTML = '';
            
            const sortedPeople = Object.entries(peopleStats)
                .sort((a, b) => b[1].count - a[1].count);
            
            sortedPeople.forEach(([name, stats]) => {
                const statItem = document.createElement('div');
                statItem.className = 'flex justify-between items-center';
                
                const nameSpan = document.createElement('span');
                nameSpan.textContent = name;
                
                const statsSpan = document.createElement('span');
                statsSpan.className = 'flex space-x-2';
                
                const countBadge = document.createElement('span');
                countBadge.className = 'badge badge-primary';
                countBadge.textContent = `${stats.count}人`;
                
                const feeBadge = document.createElement('span');
                feeBadge.className = 'badge badge-success';
                feeBadge.textContent = `¥${stats.fee.toFixed(2)}`;
                
                statsSpan.appendChild(countBadge);
                statsSpan.appendChild(feeBadge);
                
                statItem.appendChild(nameSpan);
                statItem.appendChild(statsSpan);
                
                peopleStatsElement.appendChild(statItem);
            });
        }

        // 图表功能
        function initChart() {
            const ctx = document.getElementById('feeChart').getContext('2d');
            feeChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: '费用分布',
                        data: [],
                        backgroundColor: 'rgba(230, 126, 34, 0.7)',
                        borderColor: 'rgba(230, 126, 34, 1)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: '费用 (元)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: '日期'
                            }
                        }
                    }
                }
            });
        }

        function updateChart() {
            // 按日期分组统计
            const dateMap = {};
            
            records.forEach(record => {
                if (!dateMap[record.date]) {
                    dateMap[record.date] = 0;
                }
                dateMap[record.date] += record.totalFee;
            });
            
            const dates = Object.keys(dateMap).sort();
            const fees = dates.map(date => dateMap[date]);
            
            feeChart.data.labels = dates;
            feeChart.data.datasets[0].data = fees;
            feeChart.update();
        }

        function changeChartType(type) {
            feeChart.config.type = type;
            
            // 更新按钮状态
            chartTypeButtons.forEach(btn => {
                if (btn.dataset.chartType === type) {
                    btn.classList.add('bg-blue-100', 'text-blue-700');
                    btn.classList.remove('bg-white');
                } else {
                    btn.classList.remove('bg-blue-100', 'text-blue-700');
                    btn.classList.add('bg-white');
                }
            });
            
            feeChart.update();
        }

        // 数据备份/恢复功能
        function openBackupModal() {
            backupModal.classList.remove('hidden');
        }

        function closeBackupModal() {
            backupModal.classList.add('hidden');
            backupFile = null;
            backupFileName.classList.add('hidden');
            importBackupBtn.disabled = true;
        }

        function exportBackup() {
            if (records.length === 0) {
                showNotification('没有可备份的记录', 'warning');
                return;
            }
            
            const backupData = {
                version: '1.0',
                timestamp: new Date().toISOString(),
                user: currentUser.username,
                records: records
            };
            
            const blob = new Blob([JSON.stringify(backupData, null, 2)], {type: 'application/json'});
            const url = URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `出工记录备份_${currentUser.username}_${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            
            URL.revokeObjectURL(url);
            
            showNotification('备份导出成功', 'success');
        }

        function handleBackupFileSelect(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            if (file.type !== 'application/json') {
                showNotification('请选择JSON格式的备份文件', 'error');
                return;
            }
            
            backupFile = file;
            backupFileName.textContent = file.name;
            backupFileName.classList.remove('hidden');
            importBackupBtn.disabled = false;
        }

        function importBackup() {
            if (!backupFile) {
                showNotification('请先选择备份文件', 'error');
                return;
            }
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const backupData = JSON.parse(e.target.result);
                    
                    // 验证备份数据
                    if (!backupData.user || !backupData.records || !Array.isArray(backupData.records)) {
                        throw new Error('无效的备份文件格式');
                    }
                    
                    if (backupData.user !== currentUser.username) {
                        throw new Error('备份文件不属于当前用户');
                    }
                    
                    if (confirm(`确定要从备份恢复数据吗? 这将覆盖现有的 ${records.length} 条记录`)) {
                        records = backupData.records;
                        saveRecords();
                        updateTable();
                        updateStatistics();
                        updateChart();
                        closeBackupModal();
                        showNotification('数据恢复成功', 'success');
                    }
                } catch (error) {
                    showNotification('恢复失败: ' + error.message, 'error');
                }
            };
            reader.readAsText(backupFile);
        }

        // 导出功能
        exportCSVButton.addEventListener('click', function() {
            if (records.length === 0) {
                showNotification('没有可导出的记录', 'warning');
                return;
            }
            
            const csvContent = "data:text/csv;charset=utf-8," +
                "日期,姓名,人数,现场名称,高速费,停车费,总费用\n" +
                records.map(record => 
                    `${record.date},${record.name},${record.numberOfPeople},${record.siteName},${record.highwayFee.toFixed(2)},${record.parkingFee.toFixed(2)},${record.totalFee.toFixed(2)}`
                ).join("\n");
            
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `出工记录_${currentUser?.username || ''}_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showNotification('CSV导出成功', 'success');
        });

        exportExcelButton.addEventListener('click', function() {
            if (records.length === 0) {
                showNotification('没有可导出的记录', 'warning');
                return;
            }
            
            // 准备数据
            const data = [
                ['日期', '姓名', '人数', '现场名称', '高速费', '停车费', '总费用'],
                ...records.map(record => [
                    record.date,
                    record.name,
                    record.numberOfPeople,
                    record.siteName,
                    record.highwayFee.toFixed(2),
                    record.parkingFee.toFixed(2),
                    record.totalFee.toFixed(2)
                ])
            ];
            
            // 创建工作簿
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(data);
            XLSX.utils.book_append_sheet(wb, ws, '出工记录');
            
            // 导出文件
            XLSX.writeFile(wb, `出工记录_${currentUser?.username || ''}_${new Date().toISOString().split('T')[0]}.xlsx`);
            
            showNotification('Excel导出成功', 'success');
        });

        exportPDFButton.addEventListener('click', function() {
            if (records.length === 0) {
                showNotification('没有可导出的记录', 'warning');
                return;
            }
            
            try {
                // 使用html2canvas方法，避免字体问题
                // 创建一个临时表格来渲染数据
                const tempDiv = document.createElement('div');
                tempDiv.style.width = '100%';
                tempDiv.style.padding = '20px';
                tempDiv.style.backgroundColor = 'white';
                tempDiv.style.position = 'absolute';
                tempDiv.style.left = '-9999px';
                
                // 添加标题和统计信息
                const title = document.createElement('h1');
                title.textContent = '每日出工记录汇总表';
                title.style.textAlign = 'center';
                title.style.marginBottom = '20px';
                title.style.fontFamily = 'Arial, "Microsoft YaHei", sans-serif';
                tempDiv.appendChild(title);
                
                // 添加用户和日期信息
                const infoDiv = document.createElement('div');
                infoDiv.style.marginBottom = '20px';
                infoDiv.innerHTML = `
                    <p>用户: ${currentUser?.username || '未知'}</p>
                    <p>导出时间: ${new Date().toLocaleString()}</p>
                `;
                infoDiv.style.fontFamily = 'Arial, "Microsoft YaHei", sans-serif';
                tempDiv.appendChild(infoDiv);
                
                // 添加统计信息
                const totalPeople = records.reduce((sum, r) => sum + r.numberOfPeople, 0);
                const totalFee = records.reduce((sum, r) => sum + r.totalFee, 0);
                
                const statsDiv = document.createElement('div');
                statsDiv.style.marginBottom = '20px';
                statsDiv.innerHTML = `
                    <p>总记录数: ${records.length}</p>
                    <p>总人数: ${totalPeople}</p>
                    <p>总费用: ¥${totalFee.toFixed(2)}</p>
                `;
                statsDiv.style.fontFamily = 'Arial, "Microsoft YaHei", sans-serif';
                tempDiv.appendChild(statsDiv);
                
                // 创建表格
                const table = document.createElement('table');
                table.style.width = '100%';
                table.style.borderCollapse = 'collapse';
                table.style.marginBottom = '20px';
                table.style.fontFamily = 'Arial, "Microsoft YaHei", sans-serif';
                
                // 添加表头
                const thead = document.createElement('thead');
                const headerRow = document.createElement('tr');
                ['日期', '姓名', '人数', '现场名称', '高速费(¥)', '停车费(¥)', '总费用(¥)'].forEach(text => {
                    const th = document.createElement('th');
                    th.textContent = text;
                    th.style.border = '1px solid #ddd';
                    th.style.padding = '8px';
                    th.style.backgroundColor = '#4285f4';
                    th.style.color = 'white';
                    headerRow.appendChild(th);
                });
                thead.appendChild(headerRow);
                table.appendChild(thead);
                
                // 添加表体
                const tbody = document.createElement('tbody');
                records.forEach((record, index) => {
                    const row = document.createElement('tr');
                    row.style.backgroundColor = index % 2 === 0 ? '#f2f2f2' : 'white';
                    
                    [record.date, record.name, record.numberOfPeople, record.siteName, 
                     record.highwayFee.toFixed(2), record.parkingFee.toFixed(2), record.totalFee.toFixed(2)
                    ].forEach(text => {
                        const td = document.createElement('td');
                        td.textContent = text;
                        td.style.border = '1px solid #ddd';
                        td.style.padding = '8px';
                        td.style.textAlign = 'center';
                        row.appendChild(td);
                    });
                    
                    tbody.appendChild(row);
                });
                table.appendChild(tbody);
                tempDiv.appendChild(table);
                
                // 添加到文档中但不显示
                document.body.appendChild(tempDiv);
                
                // 使用html2canvas将表格转换为图像
                html2canvas(tempDiv).then(canvas => {
                    // 移除临时元素
                    document.body.removeChild(tempDiv);
                    
                    const imgData = canvas.toDataURL('image/png');
                    const { jsPDF } = window.jspdf;
                    
                    // 创建PDF文档
                    const pdf = new jsPDF({
                        orientation: 'landscape',
                        unit: 'mm',
                        format: 'a4'
                    });
                    
                    // 计算图像尺寸以适应PDF页面
                    const pdfWidth = pdf.internal.pageSize.getWidth();
                    const pdfHeight = pdf.internal.pageSize.getHeight();
                    const imgWidth = canvas.width;
                    const imgHeight = canvas.height;
                    const ratio = Math.min(pdfWidth / imgWidth, pdfHeight / imgHeight);
                    const imgX = (pdfWidth - imgWidth * ratio) / 2;
                    const imgY = 10;
                    
                    // 添加图像到PDF
                    pdf.addImage(imgData, 'PNG', imgX, imgY, imgWidth * ratio, imgHeight * ratio);
                    
                    // 保存PDF
                    pdf.save(`出工记录_${currentUser?.username || '未知'}_${new Date().toISOString().split('T')[0]}.pdf`);
                    showNotification('PDF导出成功', 'success');
                });
            } catch (error) {
                console.error('PDF生成错误:', error);
                showNotification('PDF导出失败: ' + error.message, 'error');
            }
        });

        // 提醒功能
        function setReminder() {
            const now = new Date();
            const today = now.toISOString().split('T')[0];
            
            // 检查今天是否已有记录
            const hasRecordToday = records.some(r => r.date === today);
            if (hasRecordToday) return;
            
            const reminderTime = new Date(now.getFullYear(), now.getMonth(), now.getDate(), 8, 0, 0);
            if (now > reminderTime) {
                reminderTime.setDate(reminderTime.getDate() + 1);
            }
            
            const timeUntilReminder = reminderTime - now;
            setTimeout(() => {
                showNotification('请记录今日出工信息！', 'warning');
                setReminder();
            }, timeUntilReminder);
        }

        // 通知功能
        function showNotification(message, type = 'success') {
            notificationMessage.innerHTML = message;
            notification.className = 'notification';
            notification.classList.add(type, 'show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }
    </script>
</body>

</html>
