<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>每日考勤记录系统</title>
    <!-- 引入本地样式表 -->
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <header class="app-header">
        <div class="header-content">
            <h1>每日考勤记录系统</h1>
            <div class="user-info">
                <span id="currentUser"></span>
                <button id="logoutBtn">退出登录</button>
            </div>
        </div>
    </header>
    
    <div class="container">
        <!-- 数据录入表单 -->
        <div class="form-container">
            <h2>新增记录</h2>
            <form id="recordForm">
                <div class="form-row">
                    <div class="form-group">
                        <label for="recordDate">日期：</label>
                        <input type="date" id="recordDate" autocomplete="bday" required>
                    </div>

                    <div class="form-group">
                        <label for="name">姓名：</label>
                        <input type="text" id="name" autocomplete="name" required>
                    </div>

                    <div class="form-group">
                        <label for="peopleCount">人数：</label>
                        <input type="number" id="peopleCount" min="1" autocomplete="off" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label for="siteName">现场名称：</label>
                        <input type="text" id="siteName" autocomplete="off" required>
                    </div>

                    <div class="form-group">
                        <label for="parkingFee">停车费（円）：</label>
                        <input type="number" id="parkingFee" min="0" step="0.01" value="0" autocomplete="off">
                    </div>

                    <div class="form-group">
                        <label for="highwayFee">高速费（円）：</label>
                        <input type="number" id="highwayFee" min="0" step="0.01" value="0" autocomplete="off">
                    </div>
                </div>

                <div class="form-actions">
                    <button type="submit" class="primary-btn">保存记录</button>
                    <button type="button" id="clearForm" class="secondary-btn">清空</button>
                </div>
            </form>
        </div>
        
        <!-- 查询和统计区域 -->
        <div class="query-section">
            <h2>查询与统计</h2>
            <div class="query-options">
                <div class="form-row">
                    <div class="form-group">
                        <label for="startDate">开始日期：</label>
                        <input type="date" id="startDate">
                    </div>
                    
                    <div class="form-group">
                        <label for="endDate">结束日期：</label>
                        <input type="date" id="endDate">
                    </div>
                    
                    <div class="form-group">
                        <label for="filterName">按姓名筛选：</label>
                        <input type="text" id="filterName">
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label for="filterSite">按现场筛选：</label>
                        <input type="text" id="filterSite">
                    </div>
                    
                    <div class="form-actions">
                        <button id="queryBtn" class="primary-btn">查询</button>
                        <button id="resetQuery" class="secondary-btn">重置</button>
                    </div>
                </div>
            </div>
            
            <!-- 统计结果显示 -->
            <div class="stats-container">
                <div class="stat-card">
                    <h3>总人数</h3>
                    <p id="totalPeople">0</p>
                </div>
                <div class="stat-card">
                    <h3>总停车费</h3>
                    <p id="totalParking">0円</p>
                </div>
                <div class="stat-card">
                    <h3>总高速费</h3>
                    <p id="totalHighway">0円</p>
                </div>
                <div class="stat-card">
                    <h3>总费用</h3>
                    <p id="totalFee">0円</p>
                </div>
            </div>
        </div>
        
        <!-- 记录列表 -->
        <div class="records-container">
            <div class="section-header">
                <h2>记录列表</h2>
                <div class="actions">
                    <select id="languageSelector" style="margin-right: 10px; padding: 8px; border-radius: 4px; border: 1px solid #ddd;">
                        <option value="zh">中文</option>
                        <option value="en">English</option>
                        <option value="ja">日本語</option>
                    </select>
                    <button id="exportBtn" class="primary-btn">导出为CSV</button>
                    <button id="exportPDFBtn" class="primary-btn">导出为PDF</button>
                </div>
            </div>
            <div class="table-container">
                <table id="recordsTable">
                    <thead>
                        <tr>
                            <th>日期</th>
                            <th>姓名</th>
                            <th>人数</th>
                            <th>现场名称</th>
                            <th>停车费</th>
                            <th>高速费</th>
                            <th>操作</th>
                        </tr>
                    </thead>
                    <tbody id="recordsBody">
                        <!-- 记录将通过JavaScript动态添加 -->
                    </tbody>
                </table>
            </div>
            <div class="pagination">
                <button id="prevPage" disabled>上一页</button>
                <span id="pageInfo">第1页</span>
                <button id="nextPage" disabled>下一页</button>
            </div>
        </div>
    </div>

    <!-- 注册模态框 -->
    <div id="registerModal" class="modal">
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            <h2>注册新账户</h2>
            <form id="registerForm">
                <div class="form-group">
                    <label for="newUsername">用户名</label>
                    <input type="text" id="newUsername" required>
                </div>
                <div class="form-group">
                    <label for="newPassword">密码</label>
                    <input type="password" id="newPassword" required>
                </div>
                <div class="form-group">
                    <label for="confirmPassword">确认密码</label>
                    <input type="password" id="confirmPassword" required>
                </div>
                <div class="form-actions">
                    <button type="submit" class="primary-btn">注册</button>
                </div>
            </form>
        </div>
    </div>



    <script src="auth.js"></script>
    <script src="app.js"></script>
    <script>
        // 页面加载完成后初始化
        window.addEventListener('DOMContentLoaded', async function() {
            // 检查登录状态
            if (!JSON.parse(sessionStorage.getItem('currentUser'))) {
                window.location.href = 'index.html';
                return;
            }

            // 初始化用户数据（设置用户名）
            const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
            document.getElementById('currentUser').textContent = `欢迎，${currentUser.username}`;
    
            // 加载考勤记录
            await loadRecords();

            // 表单提交事件
            const recordForm = document.getElementById('recordForm');
            const submitButton = recordForm.querySelector('.primary-btn');

            recordForm.addEventListener('submit', async function(event) {
                event.preventDefault();

                // 禁用保存按钮以防止重复提交
                submitButton.disabled = true;

                try {
                    const record = {
                        date: document.getElementById('recordDate').value,
                        name: document.getElementById('name').value,
                        people_count: parseInt(document.getElementById('peopleCount').value),
                        site_name: document.getElementById('siteName').value,
                        parking_fee: parseFloat(document.getElementById('parkingFee').value) || 0,
                        highway_fee: parseFloat(document.getElementById('highwayFee').value) || 0
                    };

                    let result;
                    const editId = submitButton.getAttribute('data-edit-id');
                    
                    if (editId) {
                        // 编辑模式
                        result = await updateRecord(editId, record);
                        if (result && result.success) {
                            showAlert('记录更新成功！', 'success');
                            // 重置表单为新增模式
                            submitButton.textContent = '保存记录';
                            submitButton.removeAttribute('data-edit-id');
                        } else {
                            const errorMessage = result?.error || '更新记录失败，请稍后重试';
                            showAlert(`记录更新失败: ${errorMessage}`, 'error');
                        }
                    } else {
                        // 新增模式
                        result = await saveRecord(record);
                        if (result && typeof result === 'object') {
                            if ('success' in result) {
                                if (result.success) {
                                    showAlert('记录已保存！', 'success');
                                } else {
                                    const errorMessage = result.error || '保存记录失败，请稍后重试';
                                    showAlert(`记录保存失败: ${errorMessage}`, 'error');
                                }
                            } else {
                                console.error('服务器响应中缺少 success 属性:', result);
                                showAlert('服务器响应格式不正确，请检查控制台日志', 'error');
                            }
                        } else {
                            console.error('收到非对象类型的响应:', result);
                            showAlert('收到非对象类型的响应，请检查控制台日志', 'error');
                        }
                    }
                    
                    // 清空表单并重新加载记录
                    if (result && result.success) {
                        clearForm();
                        await loadRecords();
                    }
                    
                } catch (error) {
                    console.error('保存记录时出错:', error);
                    alert('保存记录失败: ' + (error.message || '请稍后重试'));
                } finally {
                    // 重新启用保存按钮
                    submitButton.disabled = false;
                }
            });

            // 查询按钮点击事件
            document.getElementById('queryBtn')?.addEventListener('click', async function() {
                const filters = {
                    startDate: document.getElementById('startDate').value,
                    endDate: document.getElementById('endDate').value,
                    name: document.getElementById('filterName').value,
                    site: document.getElementById('filterSite').value
                };

                // 获取当前用户ID
                const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
                const userId = currentUser.username;
                
                // 添加用户ID到过滤条件中
                filters.userId = userId;

                const records = await queryAttendanceRecords(filters);
                displayRecords(records);
            });

            // 重置查询
            document.getElementById('resetQuery')?.addEventListener('click', async function() {
                document.getElementById('startDate').value = '';
                document.getElementById('endDate').value = '';
                document.getElementById('filterName').value = '';
                document.getElementById('filterSite').value = '';
                await loadRecords();
            });

            // 返回仪表盘按钮事件
            document.getElementById('backToDashboard')?.addEventListener('click', function() {
                window.location.href = 'dashboard.html';
            });

            // 退出登录按钮事件
            document.getElementById('logoutBtn')?.addEventListener('click', function() {
                sessionStorage.removeItem('currentUser');
                window.location.href = 'index.html';
            });
        });

        // 加载所有记录
        async function loadRecords() {
            // 获取当前用户ID
            const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
            const userId = currentUser.username;
            
            // 调用API查询数据
            try {
                const records = await getAllAttendanceRecords(userId);
                displayRecords(records);
                updateStatistics(records);
                updatePagination(records.length);
            } catch (error) {
                console.error('加载记录失败:', error);
                showAlert('加载记录失败: ' + (error.message || '请稍后重试'), 'error');
            }
        }

        // 显示记录
        function displayRecords(records) {
            const tbody = document.getElementById('recordsBody');
            tbody.innerHTML = '';
            
            // 初始化统计数据
            let totalPeople = 0;
            let totalParking = 0;
            let totalHighway = 0;

            records.forEach(record => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${record.date}</td>
                    <td>${record.name}</td>
                    <td>${record.people_count}</td>
                    <td>${record.site_name}</td>
                    <td>${record.parking_fee.toFixed(2)}</td>
                    <td>${record.highway_fee.toFixed(2)}</td>
                    <td>
                        <button class="action-btn edit-btn" data-id="${record.id}" style="background-color: blue; color: white; margin-right: 5px;">编辑</button>
                        <button class="action-btn delete-btn" data-id="${record.id}" style="background-color: red; color: white;">删除</button>
                    </td>
                `;
                tbody.appendChild(row);
                
                // 累加统计数据
                totalPeople += record.people_count;
                totalParking += record.parking_fee;
                totalHighway += record.highway_fee;
            });
            
            // 更新统计显示
            document.getElementById('totalPeople').textContent = totalPeople;
            document.getElementById('totalParking').textContent = `${totalParking.toFixed(2)}円`;
            document.getElementById('totalHighway').textContent = `${totalHighway.toFixed(2)}円`;
            document.getElementById('totalFee').textContent = `${(totalParking + totalHighway).toFixed(2)}円`;

            // 绑定编辑和删除按钮事件
            bindActionButtons();
        }
        
        // 绑定操作按钮事件
        function bindActionButtons() {
            // 绑定删除按钮事件
            document.querySelectorAll('.delete-btn').forEach(button => {
                button.addEventListener('click', async function() {
                    const recordId = this.getAttribute('data-id');
                    await deleteRecord(recordId);
                });
            });
            
            // 绑定编辑按钮事件
            document.querySelectorAll('.edit-btn').forEach(button => {
                button.addEventListener('click', function() {
                    const recordId = this.getAttribute('data-id');
                    editRecord(recordId);
                });
            });
        }
        
        // 删除记录函数
        async function deleteRecord(recordId) {
            console.log('尝试删除记录ID:', recordId, '类型:', typeof recordId);
            if (!confirm('确定要删除这条记录吗？')) return;

            const success = await deleteAttendanceRecord(recordId);
            if (success) {
                showAlert('记录删除成功', 'success');
                await loadRecords();
            } else {
                showAlert('删除记录失败，请稍后重试', 'error');
            }
        }
        
        // 编辑记录函数
        function editRecord(recordId) {
            console.log('尝试编辑记录ID:', recordId, '类型:', typeof recordId);
            
            // 获取当前用户数据
            const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
            const userId = currentUser.username;
            const userData = getUserData();
            
            // 查找要编辑的记录（使用宽松比較）
            const record = userData.records.find(r => r.id == recordId && r.userId === userId);
            console.log('查找结果:', record);
            
            if (!record) {
                console.log('现有记录:', userData.records.map(r => ({ id: r.id, userId: r.userId })));
                showAlert('记录不存在', 'error');
                return;
            }
            
            // 填充表单数据
            document.getElementById('recordDate').value = record.date;
            document.getElementById('name').value = record.name;
            document.getElementById('peopleCount').value = record.people_count;
            document.getElementById('siteName').value = record.site_name;
            document.getElementById('parkingFee').value = record.parking_fee;
            document.getElementById('highwayFee').value = record.highway_fee;
            
            // 更改表单状态为编辑模式
            const form = document.getElementById('recordForm');
            const submitBtn = form.querySelector('.primary-btn');
            submitBtn.textContent = '更新记录';
            submitBtn.setAttribute('data-edit-id', recordId);
            
            // 滚动到表单顶部
            document.querySelector('.form-container').scrollIntoView({ behavior: 'smooth' });
            
            showAlert('记录已加载到表单，修改后点击"更新记录"', 'success');
        }
    </script>
    <!-- 引入 jsPDF 库用于PDF导出 -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js" 
            onerror="loadJsPDFBackup()"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js" 
            onerror="loadAutoTableBackup()"></script>
    
    <script>
        // 备用CDN加载方案
        function loadJsPDFBackup() {
            console.warn('主CDN加载失败，尝试备用CDN...');
            const script = document.createElement('script');
            script.src = 'https://unpkg.com/jspdf@latest/dist/jspdf.umd.min.js';
            script.onerror = function() {
                console.error('所有CDN都加载失败，PDF导出功能不可用');
            };
            document.head.appendChild(script);
        }
        
        function loadAutoTableBackup() {
            console.warn('AutoTable主CDN加载失败，尝试备用CDN...');
            const script = document.createElement('script');
            script.src = 'https://unpkg.com/jspdf-autotable@latest/dist/jspdf.plugin.autotable.min.js';
            script.onerror = function() {
                console.error('所有AutoTable CDN都加载失败');
            };
            document.head.appendChild(script);
        }
        
        // 多语言配置
        const languageConfig = {
            zh: {
                title: '每日考勤记录',
                exportDate: '导出时间',
                user: '用户',
                summary: '统计摘要',
                totalPeople: '总人数',
                totalParkingFee: '总停车费',
                totalHighwayFee: '总高速费',
                totalCost: '总费用',
                tableHeaders: ['日期', '姓名', '人数', '现场名称', '停车费(円)', '高速费(円)'],
                currency: '円',
                noRecords: '没有记录可导出',
                exportSuccess: 'PDF导出成功！',
                exportFailed: 'PDF导出失败',
                networkError: 'jsPDF库未正确加载，请检查网络连接',
                pluginError: 'jsPDF autoTable插件未加载'
            },
            en: {
                title: 'Daily Attendance Records',
                exportDate: 'Export Date',
                user: 'User',
                summary: 'Summary',
                totalPeople: 'Total People',
                totalParkingFee: 'Total Parking Fee',
                totalHighwayFee: 'Total Highway Fee',
                totalCost: 'Total Cost',
                tableHeaders: ['Date', 'Name', 'People', 'Site Name', 'Parking(JPY)', 'Highway(JPY)'],
                currency: 'JPY',
                noRecords: 'No records to export',
                exportSuccess: 'PDF export successful!',
                exportFailed: 'PDF export failed',
                networkError: 'jsPDF library not properly loaded, please check network connection',
                pluginError: 'jsPDF autoTable plugin not loaded'
            },
            ja: {
                title: '日次勤怠記録',
                exportDate: 'エクスポート日時',
                user: 'ユーザー',
                summary: '集計',
                totalPeople: '総人数',
                totalParkingFee: '総駐車料金',
                totalHighwayFee: '総高速料金',
                totalCost: '総費用',
                tableHeaders: ['日付', '氏名', '人数', '現場名', '駐車料金(円)', '高速料金(円)'],
                currency: '円',
                noRecords: 'エクスポートするレコードがありません',
                exportSuccess: 'PDFエクスポート成功！',
                exportFailed: 'PDFエクスポート失敗',
                networkError: 'jsPDFライブラリが正しく読み込まれていません。ネットワーク接続を確認してください',
                pluginError: 'jsPDF autoTableプラグインが読み込まれていません'
            }
        };
        
        // 获取当前语言设置
        function getCurrentLanguage() {
            return localStorage.getItem('preferredLanguage') || 'zh';
        }
        
        // 设置语言
        function setLanguage(lang) {
            localStorage.setItem('preferredLanguage', lang);
        }
        
        // PDF导出功能
        document.addEventListener('DOMContentLoaded', function() {
            const exportPDFBtn = document.getElementById('exportPDFBtn');
            const languageSelector = document.getElementById('languageSelector');
            
            if (exportPDFBtn) {
                exportPDFBtn.addEventListener('click', exportToPDF);
            }
            
            // 初始化语言选择器
            if (languageSelector) {
                languageSelector.value = getCurrentLanguage();
                languageSelector.addEventListener('change', function() {
                    setLanguage(this.value);
                });
            }
        });
        
        // 导出为PDF函数（多语言版，解决中日文乱码）
        async function exportToPDF() {
            try {
                // 获取当前用户数据
                const currentUser = JSON.parse(sessionStorage.getItem('currentUser'));
                const userId = currentUser.username;
                const records = await getAllAttendanceRecords(userId);
                
                // 获取当前语言配置
                const currentLang = getCurrentLanguage();
                const lang = languageConfig[currentLang];
                
                if (records.length === 0) {
                    showAlert(lang.noRecords, 'error');
                    return;
                }
                
                // 检查jsPDF是否可用
                if (typeof window.jspdf === 'undefined' || !window.jspdf.jsPDF) {
                    throw new Error(lang.networkError);
                }
                
                // 创建新的PDF文档
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // 根据语言选择合适的处理方式
                if (currentLang === 'en') {
                    // 英文使用默认字体
                    doc.setFont('helvetica', 'normal');
                    await generateEnglishPDF(doc, lang, currentUser, records);
                } else {
                    // 中文和日文使用图片方式生成PDF
                    await generateAsianLanguagePDF(doc, lang, currentUser, records, currentLang);
                }
                
                // 生成文件名
                const dateStr = new Date().toISOString().slice(0, 10);
                const fileName = `attendance_records_${currentLang}_${currentUser.username}_${dateStr}.pdf`;
                
                // 保存PDF文件
                doc.save(fileName);
                
                showAlert(lang.exportSuccess, 'success');
                
            } catch (error) {
                console.error('PDF导出详细错误:', error);
                const currentLang = getCurrentLanguage();
                const lang = languageConfig[currentLang];
                const errorMsg = error.message || '未知错误';
                showAlert(`${lang.exportFailed}: ${errorMsg}`, 'error');
            }
        }
        
        // 生成英文PDF
        async function generateEnglishPDF(doc, lang, currentUser, records) {
            doc.setFont('helvetica', 'normal');
            
            // 添加标题
            doc.setFontSize(18);
            doc.text(lang.title, 105, 20, { align: 'center' });
            
            // 添加导出信息
            doc.setFontSize(10);
            const exportTime = new Date().toLocaleDateString();
            const exportTimeStr = new Date().toLocaleTimeString();
            doc.text(`${lang.exportDate}: ${exportTime} ${exportTimeStr}`, 20, 35);
            doc.text(`${lang.user}: ${currentUser.username}`, 20, 45);
            
            // 计算统计数据
            const totalPeople = records.reduce((sum, record) => sum + (record.people_count || 0), 0);
            const totalParking = records.reduce((sum, record) => sum + (record.parking_fee || 0), 0);
            const totalHighway = records.reduce((sum, record) => sum + (record.highway_fee || 0), 0);
            const totalFee = totalParking + totalHighway;
            
            // 添加统计摘要
            doc.setFontSize(12);
            doc.setFont('helvetica', 'bold');
            doc.text(lang.summary + ':', 20, 60);
            
            doc.setFontSize(10);
            doc.setFont('helvetica', 'normal');
            doc.text(`${lang.totalPeople}: ${totalPeople}`, 30, 72);
            doc.text(`${lang.totalParkingFee}: ${totalParking.toFixed(2)} ${lang.currency}`, 30, 82);
            doc.text(`${lang.totalHighwayFee}: ${totalHighway.toFixed(2)} ${lang.currency}`, 30, 92);
            doc.text(`${lang.totalCost}: ${totalFee.toFixed(2)} ${lang.currency}`, 30, 102);
            
            // 准备表格数据
            const tableData = records.map(record => [
                record.date || 'N/A',
                record.name || 'N/A',
                (record.people_count || 0).toString(),
                record.site_name || 'N/A',
                (record.parking_fee || 0).toFixed(2),
                (record.highway_fee || 0).toFixed(2)
            ]);
            
            // 创建表格
            doc.autoTable({
                head: [lang.tableHeaders],
                body: tableData,
                startY: 115,
                styles: {
                    fontSize: 8,
                    cellPadding: 3,
                    font: 'helvetica'
                },
                headStyles: {
                    fillColor: [52, 152, 219],
                    textColor: [255, 255, 255],
                    fontSize: 9,
                    font: 'helvetica'
                }
            });
        }
        
        // 生成中文/日文PDF（使用Canvas转图片方式）
        async function generateAsianLanguagePDF(doc, lang, currentUser, records, currentLang) {
            // 创建canvas元素
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            
            // 设置canvas尺寸（A4比例）
            canvas.width = 794;  // A4宽度（像素）
            canvas.height = 1123; // A4高度（像素）
            
            // 设置背景色
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            // 设置字体（使用系统默认字体，支持中日文）
            ctx.fillStyle = '#000000';
            
            // 绘制标题
            ctx.font = 'bold 24px Arial, sans-serif';
            ctx.textAlign = 'center';
            ctx.fillText(lang.title, canvas.width / 2, 60);
            
            // 绘制导出信息
            ctx.font = '14px Arial, sans-serif';
            ctx.textAlign = 'left';
            const exportTime = new Date().toLocaleDateString();
            const exportTimeStr = new Date().toLocaleTimeString();
            ctx.fillText(`${lang.exportDate}: ${exportTime} ${exportTimeStr}`, 40, 100);
            ctx.fillText(`${lang.user}: ${currentUser.username}`, 40, 120);
            
            // 计算统计数据
            const totalPeople = records.reduce((sum, record) => sum + (record.people_count || 0), 0);
            const totalParking = records.reduce((sum, record) => sum + (record.parking_fee || 0), 0);
            const totalHighway = records.reduce((sum, record) => sum + (record.highway_fee || 0), 0);
            const totalFee = totalParking + totalHighway;
            
            // 绘制统计摘要
            ctx.font = 'bold 16px Arial, sans-serif';
            ctx.fillText(lang.summary + ':', 40, 160);
            
            ctx.font = '14px Arial, sans-serif';
            ctx.fillText(`${lang.totalPeople}: ${totalPeople}`, 60, 185);
            ctx.fillText(`${lang.totalParkingFee}: ${totalParking.toFixed(2)} ${lang.currency}`, 60, 205);
            ctx.fillText(`${lang.totalHighwayFee}: ${totalHighway.toFixed(2)} ${lang.currency}`, 60, 225);
            ctx.fillText(`${lang.totalCost}: ${totalFee.toFixed(2)} ${lang.currency}`, 60, 245);
            
            // 绘制表格标题
            ctx.font = 'bold 12px Arial, sans-serif';
            const startY = 280;
            const rowHeight = 25;
            const colWidths = [80, 80, 50, 120, 80, 80]; // 列宽
            let currentX = 40;
            
            // 绘制表头背景
            ctx.fillStyle = '#3498db';
            ctx.fillRect(40, startY - 18, colWidths.reduce((a, b) => a + b, 0), 20);
            
            // 绘制表头文字
            ctx.fillStyle = '#ffffff';
            currentX = 40;
            lang.tableHeaders.forEach((header, index) => {
                ctx.fillText(header, currentX + 5, startY - 5);
                currentX += colWidths[index];
            });
            
            // 绘制数据行
            ctx.fillStyle = '#000000';
            ctx.font = '11px Arial, sans-serif';
            
            records.slice(0, 25).forEach((record, rowIndex) => { // 限制25行避免超出页面
                const y = startY + (rowIndex + 1) * rowHeight;
                currentX = 40;
                
                // 交替行背景
                if (rowIndex % 2 === 0) {
                    ctx.fillStyle = '#f5f5f5';
                    ctx.fillRect(40, y - 18, colWidths.reduce((a, b) => a + b, 0), 20);
                    ctx.fillStyle = '#000000';
                }
                
                const rowData = [
                    record.date || 'N/A',
                    record.name || 'N/A',
                    (record.people_count || 0).toString(),
                    record.site_name || 'N/A',
                    (record.parking_fee || 0).toFixed(2),
                    (record.highway_fee || 0).toFixed(2)
                ];
                
                rowData.forEach((data, colIndex) => {
                    ctx.fillText(data, currentX + 5, y - 5);
                    currentX += colWidths[colIndex];
                });
            });
            
            // 将canvas转换为图片并添加到PDF
            const imgData = canvas.toDataURL('image/png');
            doc.addImage(imgData, 'PNG', 0, 0, 210, 297); // A4尺寸（毫米）
        }
    </script>
</body>
</html>
